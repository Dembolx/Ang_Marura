<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Matura Angielski ‚Äî Trener (Neon DB)</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      /* ====== wszystkie style z oryginalnego projektu ====== */
      :root {
        --bg: #0d0e12;
        --surface: #13151c;
        --surface2: #1c1f2a;
        --border: #2a2d3a;
        --accent: #e8c547;
        --accent2: #4fc3f7;
        --accent3: #f06292;
        --text: #e8eaf0;
        --text-muted: #6b7080;
        --success: #66bb6a;
        --error: #ef5350;
        --warn: #ffa726;
        --radius: 12px;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        background: var(--bg);
        color: var(--text);
        font-family: "DM Sans", sans-serif;
        min-height: 100vh;
      }
      /* db status bar */
      #db-status-bar {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        z-index: 9999;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 0.6rem 1rem;
        font-size: 0.78rem;
        font-family: "DM Mono", monospace;
        display: flex;
        align-items: center;
        gap: 0.6rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        transition: opacity 0.3s;
      }
      #db-status-bar .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
      }
      #db-status-bar.connected .dot {
        background: var(--success);
        box-shadow: 0 0 6px var(--success);
      }
      #db-status-bar.error .dot {
        background: var(--error);
      }
      #db-status-bar.loading .dot {
        background: var(--warn);
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }
      /* rest of styles */
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
        pointer-events: none;
        z-index: 0;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 100;
        background: rgba(13, 14, 18, 0.9);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border);
        padding: 0 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 64px;
      }
      .logo {
        font-family: "Playfair Display", serif;
        font-size: 1.4rem;
        color: var(--accent);
        letter-spacing: -0.5px;
      }
      .logo span {
        color: var(--text-muted);
        font-size: 0.85rem;
        font-family: "DM Mono", monospace;
        display: block;
        margin-top: -4px;
      }
      nav {
        display: flex;
        gap: 0.5rem;
      }
      .nav-btn {
        background: none;
        border: none;
        color: var(--text-muted);
        font-family: "DM Sans", sans-serif;
        font-size: 0.85rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .nav-btn:hover,
      .nav-btn.active {
        background: var(--surface2);
        color: var(--accent);
      }
      main {
        position: relative;
        z-index: 1;
        max-width: 960px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
      }
      .view {
        display: none;
      }
      .view.active {
        display: block;
      }
      .hero {
        text-align: center;
        padding: 3rem 0 2rem;
      }
      .hero h1 {
        font-family: "Playfair Display", serif;
        font-size: clamp(2rem, 5vw, 3.5rem);
        line-height: 1.1;
        margin-bottom: 0.75rem;
      }
      .hero h1 em {
        color: var(--accent);
        font-style: normal;
      }
      .hero p {
        color: var(--text-muted);
        font-size: 1.05rem;
        margin-bottom: 2.5rem;
      }
      .stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 2.5rem;
      }
      .stat-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.25rem;
        text-align: center;
        transition: border-color 0.2s;
      }
      .stat-card:hover {
        border-color: var(--accent);
      }
      .stat-card .val {
        font-family: "Playfair Display", serif;
        font-size: 2rem;
        font-weight: 700;
        color: var(--accent);
        display: block;
      }
      .stat-card .lbl {
        font-size: 0.78rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .categories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 1rem;
      }
      .cat-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
      }
      .cat-card::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          135deg,
          var(--cat-color, #e8c547) 0%,
          transparent 60%
        );
        opacity: 0.05;
        transition: opacity 0.2s;
      }
      .cat-card:hover {
        border-color: var(--cat-color, var(--accent));
        transform: translateY(-2px);
      }
      .cat-card:hover::before {
        opacity: 0.1;
      }
      .cat-icon {
        font-size: 2rem;
        margin-bottom: 0.75rem;
      }
      .cat-name {
        font-weight: 600;
        font-size: 1.05rem;
        margin-bottom: 0.25rem;
      }
      .cat-desc {
        font-size: 0.82rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
      }
      .cat-progress {
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        overflow: hidden;
      }
      .cat-progress-fill {
        height: 100%;
        background: var(--cat-color, var(--accent));
        border-radius: 2px;
        transition: width 0.5s;
      }
      .cat-stats {
        display: flex;
        gap: 1rem;
        margin-top: 0.75rem;
        font-size: 0.78rem;
        color: var(--text-muted);
      }
      .ex-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
      }
      .back-btn {
        background: var(--surface);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        font-family: "DM Sans", sans-serif;
        font-size: 0.85rem;
        transition: all 0.2s;
      }
      .back-btn:hover {
        border-color: var(--accent);
        color: var(--accent);
      }
      .ex-category-badge {
        font-family: "DM Mono", monospace;
        font-size: 0.78rem;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        background: var(--surface2);
        border: 1px solid var(--border);
        color: var(--text-muted);
      }
      .ex-progress-bar {
        flex: 1;
        height: 6px;
        background: var(--border);
        border-radius: 3px;
        overflow: hidden;
      }
      .ex-progress-fill {
        height: 100%;
        background: var(--accent);
        border-radius: 3px;
        transition: width 0.4s;
      }
      .ex-counter {
        font-family: "DM Mono", monospace;
        font-size: 0.85rem;
        color: var(--text-muted);
        white-space: nowrap;
      }
      .exercise-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 2rem;
        margin-bottom: 1.5rem;
        animation: slideIn 0.3s ease;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }
      .ex-type-badge {
        display: inline-block;
        font-family: "DM Mono", monospace;
        font-size: 0.72rem;
        padding: 0.25rem 0.6rem;
        border-radius: 4px;
        background: var(--surface2);
        color: var(--accent2);
        border: 1px solid var(--border);
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .ex-instruction {
        font-size: 0.88rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
        font-style: italic;
      }
      .ex-text {
        font-size: 1rem;
        line-height: 1.75;
        margin-bottom: 1.5rem;
        padding: 1rem 1.25rem;
        background: var(--surface2);
        border-radius: 8px;
        border-left: 3px solid var(--accent2);
      }
      .ex-question {
        font-size: 1.05rem;
        font-weight: 500;
        margin-bottom: 1.25rem;
        line-height: 1.6;
      }
      .options {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
      }
      .option-btn {
        background: var(--surface2);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 0.85rem 1.1rem;
        border-radius: 8px;
        cursor: pointer;
        text-align: left;
        font-family: "DM Sans", sans-serif;
        font-size: 0.95rem;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .option-btn:hover:not(:disabled) {
        border-color: var(--accent);
        background: rgba(232, 197, 71, 0.06);
      }
      .option-btn .opt-letter {
        font-family: "DM Mono", monospace;
        font-size: 0.8rem;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: var(--border);
        color: var(--text-muted);
        flex-shrink: 0;
      }
      .option-btn.correct {
        border-color: var(--success);
        background: rgba(102, 187, 106, 0.1);
      }
      .option-btn.correct .opt-letter {
        background: var(--success);
        color: #000;
      }
      .option-btn.wrong {
        border-color: var(--error);
        background: rgba(239, 83, 80, 0.1);
      }
      .option-btn.wrong .opt-letter {
        background: var(--error);
        color: #fff;
      }
      .option-btn:disabled {
        cursor: default;
        opacity: 0.7;
      }
      .ex-input {
        width: 100%;
        padding: 0.85rem 1.1rem;
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-family: "DM Mono", monospace;
        font-size: 0.95rem;
        transition: border-color 0.2s;
        outline: none;
      }
      .ex-input:focus {
        border-color: var(--accent2);
      }
      .ex-input.correct {
        border-color: var(--success);
      }
      .ex-input.wrong {
        border-color: var(--error);
      }
      textarea.ex-input {
        resize: vertical;
        min-height: 140px;
        line-height: 1.6;
        font-family: "DM Sans", sans-serif;
      }
      .fill-blanks {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .blank-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.95rem;
      }
      .blank-num {
        font-family: "DM Mono", monospace;
        font-size: 0.78rem;
        color: var(--accent);
        min-width: 28px;
      }
      .blank-input {
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text);
        font-family: "DM Mono", monospace;
        font-size: 0.95rem;
        padding: 0.5rem 0.75rem;
        outline: none;
        transition: border-color 0.2s;
        min-width: 180px;
      }
      .blank-input:focus {
        border-color: var(--accent2);
      }
      .blank-input.correct {
        border-color: var(--success);
      }
      .blank-input.wrong {
        border-color: var(--error);
      }
      .blank-hint {
        font-size: 0.82rem;
        color: var(--text-muted);
      }
      .feedback-box {
        padding: 1rem 1.25rem;
        border-radius: 8px;
        margin-top: 1.25rem;
        font-size: 0.92rem;
        line-height: 1.6;
        display: none;
        animation: fadeIn 0.2s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .feedback-box.correct {
        background: rgba(102, 187, 106, 0.1);
        border: 1px solid rgba(102, 187, 106, 0.3);
        color: var(--success);
      }
      .feedback-box.wrong {
        background: rgba(239, 83, 80, 0.1);
        border: 1px solid rgba(239, 83, 80, 0.3);
        color: #ff8a80;
      }
      .feedback-box strong {
        display: block;
        margin-bottom: 0.25rem;
      }
      .action-row {
        display: flex;
        gap: 0.75rem;
        margin-top: 1.25rem;
        justify-content: flex-end;
      }
      .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-family: "DM Sans", sans-serif;
        font-size: 0.92rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
      }
      .btn-primary {
        background: var(--accent);
        color: #000;
      }
      .btn-primary:hover {
        background: #f0d060;
      }
      .btn-secondary {
        background: var(--surface2);
        color: var(--text);
        border: 1px solid var(--border);
      }
      .btn-secondary:hover {
        border-color: var(--accent);
        color: var(--accent);
      }
      .btn:disabled {
        opacity: 0.4;
        cursor: default;
      }
      .session-results {
        text-align: center;
        padding: 3rem 2rem;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
      }
      .session-score {
        font-family: "Playfair Display", serif;
        font-size: 5rem;
        font-weight: 900;
        color: var(--accent);
        line-height: 1;
        margin: 1rem 0;
      }
      .session-score span {
        font-size: 2rem;
        color: var(--text-muted);
      }
      .session-breakdown {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin: 2rem 0;
      }
      .sb-item {
        text-align: center;
      }
      .sb-val {
        font-family: "Playfair Display", serif;
        font-size: 1.8rem;
        font-weight: 700;
      }
      .sb-lbl {
        font-size: 0.78rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      /* DB Config Panel */
      .db-config {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }
      .db-config h3 {
        font-family: "DM Mono", monospace;
        font-size: 0.82rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 1rem;
      }
      .db-input {
        width: 100%;
        padding: 0.7rem 1rem;
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--accent2);
        font-family: "DM Mono", monospace;
        font-size: 0.82rem;
        outline: none;
        transition: border-color 0.2s;
        margin-bottom: 0.75rem;
      }
      .db-input:focus {
        border-color: var(--accent2);
      }
      @media (max-width: 600px) {
        .stats-row {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: var(--bg);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted);
      }
    </style>
  </head>
  <body>
    <!-- DB STATUS INDICATOR -->
    <div id="db-status-bar" class="loading">
      <div class="dot"></div>
      <span id="db-status-text">≈ÅƒÖczenie z bazƒÖ...</span>
    </div>

    <header>
      <div class="logo">
        MATURA <em style="color: var(--accent)">EN</em>
        <span id="logo-sub">Trener Angielskiego</span>
      </div>
      <nav>
        <button class="nav-btn active" onclick="showView('home')">
          üè† Start
        </button>
        <button class="nav-btn" onclick="showView('stats')">üìä Postƒôpy</button>
        <button class="nav-btn" onclick="showView('db-config')">
          üóÑÔ∏è Baza danych
        </button>
        <button class="nav-btn" onclick="showView('import')">
          üì• Import JSON
        </button>
      </nav>
    </header>

    <main>
      <!-- HOME VIEW -->
      <div id="view-home" class="view active">
        <div class="hero">
          <h1>Zdaj maturƒô z <em>angielskiego</em></h1>
          <p>Postƒôpy zapisywane w chmurze ‚Äî Neon PostgreSQL</p>
        </div>
        <div class="stats-row" id="global-stats">
          <div class="stat-card">
            <span class="val" id="stat-total">‚Äî</span>
            <span class="lbl">Zada≈Ñ w bazie</span>
          </div>
          <div class="stat-card">
            <span class="val" id="stat-done">‚Äî</span>
            <span class="lbl">Zrobionych</span>
          </div>
          <div class="stat-card">
            <span class="val" id="stat-score">‚Äî</span>
            <span class="lbl">Skuteczno≈õƒá</span>
          </div>
          <div class="stat-card">
            <span class="val" id="stat-streak">‚Äî</span>
            <span class="lbl">Dni z rzƒôdu üî•</span>
          </div>
        </div>
        <div class="categories-grid" id="categories-grid">
          <div
            style="
              grid-column: 1/-1;
              text-align: center;
              color: var(--text-muted);
              padding: 3rem 0;
            "
          >
            <div style="font-size: 2rem; margin-bottom: 0.5rem">‚è≥</div>
            ≈Åadowanie kategorii z bazy danych...
          </div>
        </div>
      </div>

      <!-- EXERCISE VIEW -->
      <div id="view-exercise" class="view">
        <div class="ex-header">
          <button class="back-btn" onclick="endSession()">‚Üê Wr√≥ƒá</button>
          <span class="ex-category-badge" id="ex-cat-name">‚Äî</span>
          <div class="ex-progress-bar">
            <div
              class="ex-progress-fill"
              id="ex-progress-fill"
              style="width: 0%"
            ></div>
          </div>
          <span class="ex-counter" id="ex-counter">0/0</span>
        </div>
        <div id="exercise-area"></div>
      </div>

      <!-- STATS VIEW -->
      <div id="view-stats" class="view">
        <div
          style="
            font-family: &quot;Playfair Display&quot;, serif;
            font-size: 1.6rem;
            margin-bottom: 1.5rem;
          "
        >
          üìä Twoje postƒôpy
        </div>
        <div id="stats-content">
          <div
            style="color: var(--text-muted); text-align: center; padding: 3rem"
          >
            ≈Åadowanie statystyk...
          </div>
        </div>
      </div>

      <!-- DB CONFIG VIEW -->
      <div id="view-db-config" class="view">
        <div
          style="
            font-family: &quot;Playfair Display&quot;, serif;
            font-size: 1.6rem;
            margin-bottom: 0.4rem;
          "
        >
          üóÑÔ∏è Konfiguracja Bazy Danych
        </div>
        <div
          style="
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 1.75rem;
          "
        >
          Neon PostgreSQL ‚Äî po≈ÇƒÖczenie przez HTTP SQL API
        </div>

        <div class="db-config">
          <h3>// Dane po≈ÇƒÖczenia</h3>
          <div
            style="
              font-family: &quot;DM Mono&quot;, monospace;
              font-size: 0.78rem;
              color: var(--text-muted);
              margin-bottom: 1rem;
              line-height: 1.7;
            "
          >
            Host:
            <span style="color: var(--accent2)"
              >ep-old-moon-agtpam3x-pooler.c-2.eu-central-1.aws.neon.tech</span
            ><br />
            Baza: <span style="color: var(--accent2)">neondb</span>
          </div>
          <label
            style="
              font-size: 0.82rem;
              color: var(--text-muted);
              display: block;
              margin-bottom: 0.25rem;
            "
            >User ID (do identyfikacji Twoich postƒôp√≥w)</label
          >
          <input
            class="db-input"
            id="cfg-user"
            type="text"
            placeholder="np. jan_kowalski"
          />
          <div
            style="
              display: flex;
              gap: 0.75rem;
              margin-top: 0.5rem;
              flex-wrap: wrap;
            "
          >
            <button class="btn btn-primary" onclick="saveConfig()">
              üíæ Zapisz
            </button>
            <button class="btn btn-secondary" onclick="testConnection()">
              üîå Test po≈ÇƒÖczenia
            </button>
            <button class="btn btn-secondary" onclick="resetProgress()">
              üóë Resetuj postƒôpy
            </button>
          </div>
          <div
            id="cfg-msg"
            style="margin-top: 0.75rem; font-size: 0.85rem"
          ></div>
        </div>

        <div class="db-config">
          <h3>// Status po≈ÇƒÖczenia</h3>
          <div
            id="conn-details"
            style="
              font-family: &quot;DM Mono&quot;, monospace;
              font-size: 0.78rem;
              color: var(--text-muted);
              line-height: 1.8;
            "
          >
            Nie po≈ÇƒÖczono. Kliknij "Test po≈ÇƒÖczenia".
          </div>
        </div>

        <div class="db-config">
          <h3>// Historia sesji (ostatnie 10)</h3>
          <div
            id="session-history-list"
            style="color: var(--text-muted); font-size: 0.85rem"
          >
            ≈Åadowanie...
          </div>
        </div>
      </div>

      <!-- IMPORT VIEW -->
      <div id="view-import" class="view">
        <div
          style="
            font-family: &quot;Playfair Display&quot;, serif;
            font-size: 1.6rem;
            margin-bottom: 0.4rem;
          "
        >
          üì• Import zada≈Ñ z JSON
        </div>
        <div
          style="
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 1.75rem;
          "
        >
          Wgraj plik JSON lub wklej dane ‚Äî zadania zostanƒÖ dodane do bazy danych
        </div>

        <div class="db-config">
          <h3>// 1. Wybierz ≈∫r√≥d≈Ço</h3>
          <div
            style="
              display: flex;
              gap: 0.75rem;
              flex-wrap: wrap;
              margin-bottom: 1rem;
            "
          >
            <label
              class="btn btn-primary"
              style="
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
              "
            >
              üìÇ Wczytaj plik JSON
              <input
                type="file"
                id="json-file-input"
                accept=".json"
                style="display: none"
                onchange="loadJSONFile(event)"
              />
            </label>
            <button
              class="btn btn-secondary"
              onclick="
                document.getElementById('json-paste').style.display = 'block'
              "
            >
              üìã Wklej JSON
            </button>
            <button class="btn btn-secondary" onclick="loadBuiltinJSON()">
              ‚ö° Za≈Çaduj wbudowane zadania
            </button>
          </div>
          <textarea
            id="json-paste"
            class="ex-input"
            style="
              display: none;
              min-height: 160px;
              font-family: &quot;DM Mono&quot;, monospace;
              font-size: 0.78rem;
            "
            placeholder='[{"id":"r001","category":"reading",...}]'
            oninput="parseJSONPaste()"
          ></textarea>
        </div>

        <div class="db-config" id="import-preview" style="display: none">
          <h3>// 2. PodglƒÖd importu</h3>
          <div
            id="import-summary"
            style="
              font-family: &quot;DM Mono&quot;, monospace;
              font-size: 0.82rem;
              line-height: 2;
              margin-bottom: 1rem;
            "
          ></div>
          <div
            id="import-table-wrap"
            style="overflow-x: auto; max-height: 320px; overflow-y: auto"
          ></div>
        </div>

        <div class="db-config" id="import-action" style="display: none">
          <h3>// 3. Wykonaj import</h3>
          <div
            style="
              display: flex;
              gap: 0.75rem;
              align-items: center;
              flex-wrap: wrap;
            "
          >
            <button class="btn btn-primary" id="push-btn" onclick="pushToDB()">
              üöÄ Push do bazy danych
            </button>
            <button class="btn btn-secondary" onclick="clearImport()">
              üóë Wyczy≈õƒá
            </button>
            <label
              style="
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.85rem;
                color: var(--text-muted);
                cursor: pointer;
              "
            >
              <input
                type="checkbox"
                id="skip-duplicates"
                checked
                style="accent-color: var(--accent)"
              />
              Pomi≈Ñ duplikaty (ON CONFLICT DO NOTHING)
            </label>
          </div>
          <div
            id="push-log"
            style="
              margin-top: 1rem;
              font-family: &quot;DM Mono&quot;, monospace;
              font-size: 0.78rem;
              line-height: 1.8;
              max-height: 200px;
              overflow-y: auto;
            "
          ></div>
        </div>
      </div>
    </main>

    <script type="module">
      // Neon serverless driver przez esm.sh ‚Äî Pool u≈ºywa WebSocket, dzia≈Ça w przeglƒÖdarce
      import {
        Pool,
        neonConfig,
      } from "https://esm.sh/@neondatabase/serverless@1.0.0";

      // =====================================================
      // KONFIGURACJA ‚Äî Neon Pool (WebSocket, przeglƒÖdarka)
      // =====================================================
      const CONNECTION_STRING =
        "postgresql://neondb_owner:npg_w4bAGP3HiZYa@ep-old-moon-agtpam3x-pooler.c-2.eu-central-1.aws.neon.tech/neondb?sslmode=require";

      // Pool obs≈Çuguje dynamiczne zapytania z parametrami ‚Äî bez problemu tagged-template
      const _pool = new Pool({ connectionString: CONNECTION_STRING });

      const CONFIG = {
        get user() {
          return localStorage.getItem("neon_user") || "default";
        },
      };

      function saveConfig() {
        localStorage.setItem(
          "neon_user",
          document.getElementById("cfg-user").value.trim(),
        );
        showMsg("cfg-msg", "‚úÖ Zapisano. ≈ÅƒÖczenie...", "success");
        init();
      }

      // =====================================================
      // API HELPER ‚Äî sql(query, params)
      // =====================================================
      async function sql(query, params = []) {
        const result = await _pool.query(query, params);
        return result.rows;
      }

      // =====================================================
      // STAN APLIKACJI
      // =====================================================
      let exercises = [];
      let progress = {}; // exercise_id -> {attempts, correct}
      let session = {
        exercises: [],
        current: 0,
        correct: 0,
        wrong: 0,
        startTime: null,
        category: null,
        answered: false,
      };
      let streak = 0;

      const CATEGORIES = {
        reading: { name: "Rozumienie Tekst√≥w", icon: "üìñ", color: "#4fc3f7" },
        grammar: { name: "Gramatyka", icon: "üîß", color: "#f06292" },
        vocabulary: { name: "S≈Çownictwo", icon: "üìö", color: "#a5d6a7" },
        use_of_english: {
          name: "Use of English",
          icon: "‚öôÔ∏è",
          color: "#ffb74d",
        },
        writing: { name: "Wypowied≈∫ Pisemna", icon: "‚úçÔ∏è", color: "#ce93d8" },
        listening_text: {
          name: "Tekst S≈Çuchany",
          icon: "üéß",
          color: "#80cbc4",
        },
      };

      // =====================================================
      // INICJALIZACJA
      // =====================================================
      async function init() {
        setDBStatus("loading", "≈ÅƒÖczenie z bazƒÖ...");
        try {
          // Pobierz zadania
          exercises = await sql(
            `SELECT * FROM exercises WHERE level = 'rozszerzony' ORDER BY id`,
          );

          // Pobierz postƒôpy
          const prog = await sql(
            `SELECT * FROM user_progress WHERE user_id = $1`,
            [CONFIG.user],
          );
          progress = {};
          prog.forEach((p) => {
            progress[p.exercise_id] = {
              attempts: p.attempts,
              correct: p.correct,
            };
          });

          // Pobierz streak
          try {
            const strData = await sql(
              `SELECT streak_count FROM user_streak WHERE user_id = $1`,
              [CONFIG.user],
            );
            streak = strData[0]?.streak_count || 0;
          } catch (e) {
            streak = 0;
          }

          setDBStatus("connected", `Po≈ÇƒÖczono ¬∑ ${exercises.length} zada≈Ñ`);
          renderHome();
        } catch (e) {
          setDBStatus("error", "B≈ÇƒÖd po≈ÇƒÖczenia");
          showLocalFallback(e.message);
        }
      }

      function setDBStatus(state, text) {
        const bar = document.getElementById("db-status-bar");
        const txt = document.getElementById("db-status-text");
        bar.className = state;
        txt.textContent = text;
      }

      function showLocalFallback(err) {
        document.getElementById("categories-grid").innerHTML = `
    <div style="grid-column:1/-1;background:rgba(239,83,80,.08);border:1px solid rgba(239,83,80,.25);border-radius:12px;padding:2rem;text-align:center">
      <div style="font-size:2rem;margin-bottom:.75rem">‚ö†Ô∏è</div>
      <div style="font-weight:600;color:var(--error);margin-bottom:.5rem">Brak po≈ÇƒÖczenia z bazƒÖ danych</div>
      <div style="color:var(--text-muted);font-size:.85rem;margin-bottom:1rem">${err}</div>
      <div style="display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="init()">üîÑ Spr√≥buj ponownie</button>
        <button class="btn btn-secondary" onclick="showView('db-config')">‚öôÔ∏è Konfiguracja bazy</button>
      </div>
    </div>`;
        document.getElementById("stat-total").textContent = "‚Äî";
        document.getElementById("stat-done").textContent = "‚Äî";
        document.getElementById("stat-score").textContent = "‚Äî";
        document.getElementById("stat-streak").textContent = "‚Äî";
      }

      // =====================================================
      // HOME
      // =====================================================
      function renderHome() {
        const total = exercises.length;
        const done = Object.keys(progress).length;
        const allAttempts = Object.values(progress).reduce(
          (a, p) => a + p.attempts,
          0,
        );
        const allCorrect = Object.values(progress).reduce(
          (a, p) => a + p.correct,
          0,
        );
        const score =
          allAttempts > 0 ? Math.round((allCorrect / allAttempts) * 100) : 0;

        document.getElementById("stat-total").textContent = total;
        document.getElementById("stat-done").textContent = done;
        document.getElementById("stat-score").textContent = score + "%";
        document.getElementById("stat-streak").textContent = streak;

        const grid = document.getElementById("categories-grid");
        grid.innerHTML = "";

        Object.entries(CATEGORIES).forEach(([key, cat]) => {
          const catExs = exercises.filter((e) => e.category_id === key);
          const catDone = catExs.filter((e) => progress[e.id]).length;
          const catAtt = catExs.reduce(
            (a, e) => a + (progress[e.id]?.attempts || 0),
            0,
          );
          const catCorr = catExs.reduce(
            (a, e) => a + (progress[e.id]?.correct || 0),
            0,
          );
          const catScore =
            catAtt > 0 ? Math.round((catCorr / catAtt) * 100) : 0;
          const pct =
            catExs.length > 0 ? Math.round((catDone / catExs.length) * 100) : 0;

          const card = document.createElement("div");
          card.className = "cat-card";
          card.style.setProperty("--cat-color", cat.color);
          card.innerHTML = `
      <div class="cat-icon">${cat.icon}</div>
      <div class="cat-name">${cat.name}</div>
      <div class="cat-desc">${catExs.length} zada≈Ñ dostƒôpnych</div>
      <div class="cat-progress"><div class="cat-progress-fill" style="width:${pct}%;background:${cat.color}"></div></div>
      <div class="cat-stats">
        <span>${catExs.length} zada≈Ñ</span>
        <span>${catDone} zrobionych</span>
        <span>${catScore}% trafnych</span>
      </div>`;
          card.onclick = () => startSession(key);
          grid.appendChild(card);
        });
      }

      // =====================================================
      // SESSION
      // =====================================================
      function startSession(category) {
        const all = exercises.filter((e) => e.category_id === category);
        if (!all.length) {
          alert("Brak zada≈Ñ w tej kategorii.");
          return;
        }

        all.sort((a, b) => {
          const pa = progress[a.id],
            pb = progress[b.id];
          if (!pa && !pb) return 0;
          if (!pa) return -1;
          if (!pb) return 1;
          const ra = pa.attempts > 0 ? pa.correct / pa.attempts : 0;
          const rb = pb.attempts > 0 ? pb.correct / pb.attempts : 0;
          return ra - rb;
        });

        session = {
          exercises: all,
          current: 0,
          correct: 0,
          wrong: 0,
          startTime: Date.now(),
          category,
          answered: false,
        };
        showView("exercise");
        document
          .querySelectorAll(".nav-btn")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById("ex-cat-name").textContent =
          CATEGORIES[category]?.name || category;
        renderExercise();
      }

      function renderExercise() {
        const ex = session.exercises[session.current];
        if (!ex) {
          showSessionResults();
          return;
        }

        session.answered = false;
        const total = session.exercises.length;
        const idx = session.current + 1;
        document.getElementById("ex-counter").textContent = `${idx}/${total}`;
        document.getElementById("ex-progress-fill").style.width =
          ((idx - 1) / total) * 100 + "%";

        const TYPE_LABELS = {
          multiple_choice: "Wielokrotny wyb√≥r",
          fill_blank: "Uzupe≈Çnij luki",
          true_false_ng: "Prawda / Fa≈Çsz / Brak",
          sentence_transform: "Transformacja zda≈Ñ",
          essay: "Wypowied≈∫ pisemna",
          email: "E-mail",
          open_answer: "Odpowied≈∫ otwarta",
        };

        // Parse options/blanks from JSONB (already parsed by JS)
        const options = ex.options
          ? typeof ex.options === "string"
            ? JSON.parse(ex.options)
            : ex.options
          : null;
        const blanks = ex.blanks
          ? typeof ex.blanks === "string"
            ? JSON.parse(ex.blanks)
            : ex.blanks
          : null;

        let inputHTML = "";
        if (ex.type === "multiple_choice" || ex.type === "true_false_ng") {
          inputHTML =
            `<div class="options">` +
            (options || [])
              .map((o, i) => {
                const letter = String.fromCharCode(65 + i);
                return `<button class="option-btn" onclick="checkOption(this,'${letter}','${ex.answer}')" data-letter="${letter}">
          <span class="opt-letter">${letter}</span>${o.replace(/^[A-D]\.\s*/, "")}
        </button>`;
              })
              .join("") +
            `</div>`;
        } else if (ex.type === "fill_blank" && blanks?.length) {
          inputHTML =
            `<div class="fill-blanks">` +
            blanks
              .map(
                (b) => `<div class="blank-row">
        <span class="blank-num">${b.num}.</span>
        <input class="blank-input" type="text" id="blank-${b.num}" placeholder="${b.hint || "odpowied≈∫"}" autocomplete="off">
        <span class="blank-hint" id="blank-hint-${b.num}"></span>
      </div>`,
              )
              .join("") +
            `</div>`;
        } else if (ex.type === "fill_blank") {
          inputHTML = `<input class="ex-input" type="text" id="single-input" placeholder="Wpisz odpowied≈∫..." autocomplete="off">`;
        } else if (
          ex.type === "sentence_transform" ||
          ex.type === "open_answer"
        ) {
          inputHTML = `<input class="ex-input" type="text" id="single-input" placeholder="Wpisz odpowied≈∫ (2‚Äì5 wyraz√≥w)..." autocomplete="off">`;
        } else if (ex.type === "essay" || ex.type === "email") {
          inputHTML = `<textarea class="ex-input" id="essay-input" placeholder="Napisz swojƒÖ wypowied≈∫ tutaj..."></textarea>`;
        }

        const area = document.getElementById("exercise-area");
        area.innerHTML = `
    <div class="exercise-card">
      <span class="ex-type-badge">${TYPE_LABELS[ex.type] || ex.type}${ex.year ? " ¬∑ " + ex.year : ""}</span>
      ${ex.instruction ? `<div class="ex-instruction">${ex.instruction}</div>` : ""}
      ${ex.text ? `<div class="ex-text">${ex.text.replace(/\n/g, "<br>")}</div>` : ""}
      <div class="ex-question">${(ex.question || "").replace(/\n/g, "<br>")}</div>
      ${inputHTML}
      <div class="feedback-box" id="feedback-box"></div>
      <div class="action-row">
        ${
          ex.type === "essay" || ex.type === "email"
            ? `<button class="btn btn-secondary" onclick="selfGrade(true)">‚úÖ Poprawne</button>
             <button class="btn btn-secondary" onclick="selfGrade(false)" style="border-color:var(--error);color:var(--error)">‚ùå Do poprawy</button>`
            : `<button class="btn btn-primary" id="check-btn" onclick="checkAnswer()">Sprawd≈∫</button>`
        }
        <button class="btn btn-secondary" id="next-btn" onclick="nextExercise()" style="display:none">Nastƒôpne ‚Üí</button>
      </div>
    </div>`;
      }

      function checkOption(btn, letter, correct) {
        if (session.answered) return;
        session.answered = true;
        const ex = session.exercises[session.current];
        const isCorrect = letter === correct;
        document.querySelectorAll(".option-btn").forEach((b) => {
          b.disabled = true;
          if (b.dataset.letter === correct) b.classList.add("correct");
          if (b === btn && !isCorrect) b.classList.add("wrong");
        });
        showFeedback(isCorrect, ex.explanation, correct);
        recordResult(ex.id, isCorrect);
        document.getElementById("next-btn").style.display = "inline-flex";
      }

      function checkAnswer() {
        if (session.answered) return;
        const ex = session.exercises[session.current];
        const blanks = ex.blanks
          ? typeof ex.blanks === "string"
            ? JSON.parse(ex.blanks)
            : ex.blanks
          : null;
        let isCorrect = false;

        if (ex.type === "fill_blank" && blanks?.length) {
          let allOk = true;
          blanks.forEach((b) => {
            const inp = document.getElementById("blank-" + b.num);
            if (!inp) return;
            const ok =
              inp.value.trim().toLowerCase() === b.answer.toLowerCase();
            inp.classList.add(ok ? "correct" : "wrong");
            const hint = document.getElementById("blank-hint-" + b.num);
            if (hint) hint.textContent = ok ? "‚úì" : "‚úó " + b.answer;
            if (!ok) allOk = false;
          });
          isCorrect = allOk;
        } else {
          const inp = document.getElementById("single-input");
          if (inp) {
            isCorrect =
              inp.value.trim().toLowerCase() === ex.answer?.toLowerCase();
            inp.classList.add(isCorrect ? "correct" : "wrong");
            inp.disabled = true;
          }
        }

        session.answered = true;
        showFeedback(isCorrect, ex.explanation, ex.answer);
        recordResult(ex.id, isCorrect);
        document.getElementById("check-btn").style.display = "none";
        document.getElementById("next-btn").style.display = "inline-flex";
      }

      function selfGrade(passed) {
        session.answered = true;
        const ex = session.exercises[session.current];
        showFeedback(
          passed,
          ex.explanation || "Oce≈Ñ strukturƒô, sp√≥jno≈õƒá i poprawno≈õƒá jƒôzykowƒÖ.",
          null,
        );
        recordResult(ex.id, passed);
        document.getElementById("next-btn").style.display = "inline-flex";
      }

      function showFeedback(isCorrect, explanation, correct) {
        const fb = document.getElementById("feedback-box");
        fb.className = "feedback-box " + (isCorrect ? "correct" : "wrong");
        fb.style.display = "block";
        fb.innerHTML = `<strong>${isCorrect ? "‚úÖ Poprawnie!" : "‚ùå Niepoprawnie"}</strong>
    ${!isCorrect && correct ? `<div>Poprawna odpowied≈∫: <strong>${correct}</strong></div>` : ""}
    ${explanation ? `<div style="margin-top:.5rem;color:var(--text-muted);font-size:.88rem">${explanation}</div>` : ""}`;
        if (isCorrect) session.correct++;
        else session.wrong++;
      }

      // =====================================================
      // ZAPIS POSTƒòP√ìW DO NEON DB
      // =====================================================
      async function recordResult(exerciseId, isCorrect) {
        const current = progress[exerciseId] || { attempts: 0, correct: 0 };
        const newAttempts = current.attempts + 1;
        const newCorrect = current.correct + (isCorrect ? 1 : 0);
        progress[exerciseId] = { attempts: newAttempts, correct: newCorrect };

        // Zapisz postƒôp ‚Äî upsert przez ON CONFLICT
        try {
          await sql(
            `INSERT INTO user_progress (user_id, exercise_id, attempts, correct, last_seen)
       VALUES ($1, $2, $3, $4, NOW())
       ON CONFLICT (user_id, exercise_id)
       DO UPDATE SET attempts = $3, correct = $4, last_seen = NOW()`,
            [CONFIG.user, exerciseId, newAttempts, newCorrect],
          );
        } catch (e) {
          console.warn("Nie uda≈Ço siƒô zapisaƒá postƒôp√≥w:", e.message);
        }

        // Aktualizuj streak
        try {
          const today = new Date().toISOString().slice(0, 10);
          await sql(
            `INSERT INTO user_streak (user_id, last_date, streak_count)
       VALUES ($1, $2, 1)
       ON CONFLICT (user_id)
       DO UPDATE SET
         streak_count = CASE
           WHEN user_streak.last_date = ($2::date - 1) THEN user_streak.streak_count + 1
           WHEN user_streak.last_date = $2::date THEN user_streak.streak_count
           ELSE 1
         END,
         last_date = $2`,
            [CONFIG.user, today],
          );
        } catch (e) {
          console.warn("Streak:", e.message);
        }
      }

      function nextExercise() {
        session.current++;
        renderExercise();
      }

      function showSessionResults() {
        const elapsed = Math.round((Date.now() - session.startTime) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        const total = session.correct + session.wrong;
        const pct = total > 0 ? Math.round((session.correct / total) * 100) : 0;

        // Zapisz historiƒô sesji
        sql(
          `INSERT INTO session_history (user_id, category_id, score, total, duration_seconds, level)
     VALUES ($1, $2, $3, $4, $5, 'rozszerzony')`,
          [CONFIG.user, session.category, session.correct, total, elapsed],
        ).catch((e) => console.warn("Historia:", e.message));

        const scoreColor =
          pct >= 70
            ? "var(--success)"
            : pct >= 50
              ? "var(--warn)"
              : "var(--error)";
        const emoji =
          pct >= 90 ? "üèÜ" : pct >= 70 ? "üéâ" : pct >= 50 ? "üí™" : "üìö";

        document.getElementById("exercise-area").innerHTML = `
    <div class="session-results">
      <div style="font-size:1.4rem">${emoji}</div>
      <div class="session-score" style="color:${scoreColor}">${pct}<span>%</span></div>
      <div style="color:var(--text-muted);margin-bottom:1.5rem">${CATEGORIES[session.category]?.name || session.category}</div>
      <div class="session-breakdown">
        <div class="sb-item"><div class="sb-val" style="color:var(--success)">${session.correct}</div><div class="sb-lbl">Poprawnych</div></div>
        <div class="sb-item"><div class="sb-val" style="color:var(--error)">${session.wrong}</div><div class="sb-lbl">B≈Çƒôdnych</div></div>
        <div class="sb-item"><div class="sb-val" style="color:var(--accent2)">${mins}m ${secs}s</div><div class="sb-lbl">Czas</div></div>
      </div>
      <div class="action-row" style="justify-content:center;gap:1rem;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="startSession('${session.category}')">üîÑ ƒÜwicz ponownie</button>
        <button class="btn btn-secondary" onclick="endSession()">‚Üê Kategorie</button>
        <button class="btn btn-secondary" onclick="showView('stats')">üìä Postƒôpy</button>
      </div>
    </div>`;
      }

      function endSession() {
        showView("home");
        renderHome();
      }

      // =====================================================
      // STATS VIEW
      // =====================================================
      async function renderStats() {
        const el = document.getElementById("stats-content");
        el.innerHTML =
          '<div style="color:var(--text-muted);text-align:center;padding:2rem">≈Åadowanie...</div>';
        try {
          const history = await sql(
            `SELECT * FROM session_history WHERE user_id = $1 ORDER BY played_at DESC LIMIT 20`,
            [CONFIG.user],
          );

          let html =
            "<div style=\"font-family:'Playfair Display',serif;font-size:1.2rem;margin-bottom:1rem\">Historia sesji</div>";

          if (!history.length) {
            html +=
              '<div style="color:var(--text-muted)">Brak historii. Zacznij ƒáwiczyƒá!</div>';
          } else {
            html += `<table style="width:100%;border-collapse:collapse;font-size:.88rem">
        <thead><tr>
          <th style="text-align:left;padding:.75rem 1rem;border-bottom:1px solid var(--border);color:var(--text-muted);font-family:'DM Mono',monospace;font-size:.75rem;text-transform:uppercase">Data</th>
          <th style="text-align:left;padding:.75rem 1rem;border-bottom:1px solid var(--border);color:var(--text-muted);font-family:'DM Mono',monospace;font-size:.75rem;text-transform:uppercase">Kategoria</th>
          <th style="text-align:left;padding:.75rem 1rem;border-bottom:1px solid var(--border);color:var(--text-muted);font-family:'DM Mono',monospace;font-size:.75rem;text-transform:uppercase">Wynik</th>
          <th style="text-align:left;padding:.75rem 1rem;border-bottom:1px solid var(--border);color:var(--text-muted);font-family:'DM Mono',monospace;font-size:.75rem;text-transform:uppercase">%</th>
        </tr></thead><tbody>`;

            history.forEach((h) => {
              const pct =
                h.total > 0 ? Math.round((h.score / h.total) * 100) : 0;
              const cls =
                pct >= 70
                  ? "var(--success)"
                  : pct >= 50
                    ? "var(--warn)"
                    : "var(--error)";
              const date = new Date(h.played_at).toLocaleDateString("pl-PL");
              html += `<tr>
          <td style="padding:.75rem 1rem;border-bottom:1px solid rgba(42,45,58,.5)">${date}</td>
          <td style="padding:.75rem 1rem;border-bottom:1px solid rgba(42,45,58,.5)">${CATEGORIES[h.category_id]?.name || h.category_id}</td>
          <td style="padding:.75rem 1rem;border-bottom:1px solid rgba(42,45,58,.5)">${h.score}/${h.total}</td>
          <td style="padding:.75rem 1rem;border-bottom:1px solid rgba(42,45,58,.5);color:${cls};font-family:'DM Mono',monospace">${pct}%</td>
        </tr>`;
            });
            html += "</tbody></table>";
          }

          // Statystyki per kategoria
          html +=
            "<div style=\"font-family:'Playfair Display',serif;font-size:1.2rem;margin:2rem 0 1rem\">Wyniki wg kategorii</div>";
          Object.entries(CATEGORIES).forEach(([key, cat]) => {
            const catExs = exercises.filter((e) => e.category_id === key);
            const att = catExs.reduce(
              (a, e) => a + (progress[e.id]?.attempts || 0),
              0,
            );
            const corr = catExs.reduce(
              (a, e) => a + (progress[e.id]?.correct || 0),
              0,
            );
            const pct = att > 0 ? Math.round((corr / att) * 100) : 0;
            html += `<div style="display:flex;align-items:center;gap:1rem;margin-bottom:.75rem">
        <span style="min-width:180px;font-size:.85rem;color:var(--text-muted)">${cat.icon} ${cat.name}</span>
        <div style="flex:1;height:20px;background:var(--surface2);border-radius:6px;overflow:hidden">
          <div style="height:100%;width:${pct}%;background:${cat.color};border-radius:6px;transition:width .6s"></div>
        </div>
        <span style="font-family:'DM Mono',monospace;font-size:.82rem;min-width:40px;color:${pct >= 70 ? "var(--success)" : pct >= 50 ? "var(--warn)" : "var(--error)"}">${pct}%</span>
      </div>`;
          });

          el.innerHTML = html;
        } catch (e) {
          el.innerHTML = `<div style="color:var(--error)">B≈ÇƒÖd ≈Çadowania statystyk: ${e.message}</div>`;
        }
      }

      // =====================================================
      // DB CONFIG VIEW
      // =====================================================
      async function testConnection() {
        const det = document.getElementById("conn-details");
        det.textContent = "Testowanie...";
        try {
          const data = await sql(`SELECT COUNT(*) as cnt FROM exercises`);
          const cnt = data[0]?.cnt ?? "?";
          det.innerHTML = `<span style="color:var(--success)">‚úÖ Po≈ÇƒÖczono pomy≈õlnie!</span>\nProxy: http://localhost:3000\nUser: ${CONFIG.user}\nZada≈Ñ w bazie: ${cnt}`;
          setDBStatus("connected", "Po≈ÇƒÖczono");
        } catch (e) {
          det.innerHTML = `<span style="color:var(--error)">‚ùå B≈ÇƒÖd: ${e.message}</span>`;
          setDBStatus("error", "B≈ÇƒÖd po≈ÇƒÖczenia");
        }
      }

      async function resetProgress() {
        if (
          !confirm(
            "Czy na pewno chcesz usunƒÖƒá WSZYSTKIE postƒôpy z bazy danych?",
          )
        )
          return;
        try {
          await sql(`DELETE FROM user_progress WHERE user_id = $1`, [
            CONFIG.user,
          ]);
          await sql(`DELETE FROM session_history WHERE user_id = $1`, [
            CONFIG.user,
          ]);
          progress = {};
          showMsg("cfg-msg", "‚úÖ Postƒôpy zosta≈Çy zresetowane.", "success");
          renderHome();
        } catch (e) {
          showMsg("cfg-msg", "‚ùå B≈ÇƒÖd: " + e.message, "error");
        }
      }

      async function loadSessionHistory() {
        const el = document.getElementById("session-history-list");
        try {
          const data = await sql(
            `SELECT * FROM session_history WHERE user_id = $1 ORDER BY played_at DESC LIMIT 10`,
            [CONFIG.user],
          );
          if (!data.length) {
            el.textContent = "Brak historii sesji.";
            return;
          }
          el.innerHTML = data
            .map((h) => {
              const pct =
                h.total > 0 ? Math.round((h.score / h.total) * 100) : 0;
              return `<div style="padding:.4rem 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between">
        <span>${new Date(h.played_at).toLocaleString("pl-PL")}</span>
        <span style="color:var(--text-muted)">${CATEGORIES[h.category_id]?.name || h.category_id}</span>
        <span style="color:${pct >= 70 ? "var(--success)" : pct >= 50 ? "var(--warn)" : "var(--error)"};font-family:'DM Mono',monospace">${pct}%</span>
      </div>`;
            })
            .join("");
        } catch (e) {
          el.textContent = "B≈ÇƒÖd ≈Çadowania: " + e.message;
        }
      }

      function showMsg(id, text, type) {
        const el = document.getElementById(id);
        if (!el) return;
        el.style.color = type === "success" ? "var(--success)" : "var(--error)";
        el.textContent = text;
        setTimeout(() => {
          el.textContent = "";
        }, 4000);
      }

      // =====================================================
      // VIEWS
      // =====================================================
      function showView(name) {
        document
          .querySelectorAll(".view")
          .forEach((v) => v.classList.remove("active"));
        document
          .querySelectorAll(".nav-btn")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById("view-" + name).classList.add("active");
        document.querySelectorAll(".nav-btn").forEach((b) => {
          if (b.getAttribute("onclick") === `showView('${name}')`)
            b.classList.add("active");
        });
        if (name === "home") renderHome();
        if (name === "stats") renderStats();
        if (name === "db-config") {
          document.getElementById("cfg-user").value = CONFIG.user;
          loadSessionHistory();
        }
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // =====================================================
      // INIT
      // =====================================================
      init();

      // Eksport funkcji do globalnego scope (wymagany przy type="module")
      // =====================================================
      // IMPORT JSON ‚Üí NEON DB
      // =====================================================
      let importData = [];

      function loadJSONFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const parsed = JSON.parse(e.target.result);
            importData = Array.isArray(parsed) ? parsed : [parsed];
            renderImportPreview();
          } catch (err) {
            logPush("Blad parsowania pliku: " + err.message, "error");
          }
        };
        reader.readAsText(file);
      }

      function parseJSONPaste() {
        const val = document.getElementById("json-paste").value.trim();
        if (!val) {
          importData = [];
          return;
        }
        try {
          const parsed = JSON.parse(val);
          importData = Array.isArray(parsed) ? parsed : [parsed];
          renderImportPreview();
        } catch (e) {
          /* niepelny JSON */
        }
      }

      function loadBuiltinJSON() {
        logPush(
          "Wbudowane zadania sa juz w bazie. Wczytaj nowy plik JSON z dysku.",
          "info",
        );
      }

      function clearImport() {
        importData = [];
        document.getElementById("import-preview").style.display = "none";
        document.getElementById("import-action").style.display = "none";
        document.getElementById("push-log").innerHTML = "";
        document.getElementById("json-paste").value = "";
        document.getElementById("json-paste").style.display = "none";
        const fi = document.getElementById("json-file-input");
        if (fi) fi.value = "";
      }

      async function renderImportPreview() {
        const preview = document.getElementById("import-preview");
        const action = document.getElementById("import-action");
        if (!importData.length) {
          preview.style.display = "none";
          action.style.display = "none";
          return;
        }

        let existingIds = new Set();
        try {
          const rows = await sql("SELECT id FROM exercises");
          rows.forEach((r) => existingIds.add(r.id));
        } catch (e) {}

        const newItems = importData.filter((e) => !existingIds.has(e.id));
        const dupItems = importData.filter((e) => existingIds.has(e.id));

        const catCounts = {};
        importData.forEach((e) => {
          const cat = e.category || "unknown";
          catCounts[cat] = (catCounts[cat] || 0) + 1;
        });

        document.getElementById("import-summary").innerHTML =
          'Lacznie w pliku: <strong style="color:var(--accent)">' +
          importData.length +
          "</strong>\n" +
          'Nowe (do dodania): <strong style="color:var(--success)">' +
          newItems.length +
          "</strong>\n" +
          'Duplikaty (juz w bazie): <strong style="color:var(--warn)">' +
          dupItems.length +
          "</strong>\n\n" +
          "Kategorie:\n" +
          Object.entries(catCounts)
            .map(
              ([k, v]) =>
                "  " +
                (CATEGORIES[k]
                  ? CATEGORIES[k].icon + " " + CATEGORIES[k].name
                  : k) +
                ": " +
                v,
            )
            .join("\n");

        const preview50 = importData.slice(0, 50);
        let tbl =
          '<table style="width:100%;border-collapse:collapse;font-size:.78rem"><thead><tr>' +
          ["ID", "Kategoria", "Typ", "Rok", "Status"]
            .map(
              (h) =>
                '<th style="text-align:left;padding:.4rem .75rem;border-bottom:1px solid var(--border);color:var(--text-muted)">' +
                h +
                "</th>",
            )
            .join("") +
          "</tr></thead><tbody>";

        preview50.forEach((e) => {
          const isDup = existingIds.has(e.id);
          tbl +=
            '<tr style="opacity:' +
            (isDup ? ".6" : "1") +
            '">' +
            "<td style=\"padding:.35rem .75rem;border-bottom:1px solid rgba(42,45,58,.4);font-family:'DM Mono',monospace;color:var(--accent2)\">" +
            e.id +
            "</td>" +
            '<td style="padding:.35rem .75rem;border-bottom:1px solid rgba(42,45,58,.4)">' +
            (CATEGORIES[e.category]
              ? CATEGORIES[e.category].icon + " " + e.category
              : e.category || "-") +
            "</td>" +
            '<td style="padding:.35rem .75rem;border-bottom:1px solid rgba(42,45,58,.4);color:var(--text-muted)">' +
            (e.type || "-") +
            "</td>" +
            '<td style="padding:.35rem .75rem;border-bottom:1px solid rgba(42,45,58,.4);color:var(--text-muted)">' +
            (e.year || "-") +
            "</td>" +
            '<td style="padding:.35rem .75rem;border-bottom:1px solid rgba(42,45,58,.4);color:' +
            (isDup ? "var(--warn)" : "var(--success)") +
            '">' +
            (isDup ? "duplikat" : "nowe") +
            "</td>" +
            "</tr>";
        });
        if (importData.length > 50)
          tbl +=
            '<tr><td colspan="5" style="padding:.5rem .75rem;color:var(--text-muted)">... i ' +
            (importData.length - 50) +
            " wiecej</td></tr>";
        tbl += "</tbody></table>";

        document.getElementById("import-table-wrap").innerHTML = tbl;
        preview.style.display = "block";
        action.style.display = "block";
        document.getElementById("push-log").innerHTML = "";
      }

      async function pushToDB() {
        const skipDups = document.getElementById("skip-duplicates").checked;
        const btn = document.getElementById("push-btn");
        btn.disabled = true;
        btn.textContent = "Importuje...";
        const log = document.getElementById("push-log");
        log.innerHTML = "";
        let inserted = 0,
          errors = 0;

        logPush(
          "Rozpoczynam import " + importData.length + " zadan...",
          "info",
        );

        for (let i = 0; i < importData.length; i++) {
          const e = importData[i];
          const conflictClause = skipDups
            ? "ON CONFLICT (id) DO NOTHING"
            : "ON CONFLICT (id) DO UPDATE SET category_id=EXCLUDED.category_id, type=EXCLUDED.type, year=EXCLUDED.year, instruction=EXCLUDED.instruction, text=EXCLUDED.text, question=EXCLUDED.question, answer=EXCLUDED.answer, explanation=EXCLUDED.explanation, options=EXCLUDED.options, blanks=EXCLUDED.blanks";

          try {
            await sql(
              "INSERT INTO exercises (id,category_id,level,type,year,instruction,text,question,answer,explanation,options,blanks) VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12) " +
                conflictClause,
              [
                e.id,
                e.category || null,
                "rozszerzony",
                e.type || null,
                e.year || null,
                e.instruction || null,
                e.text || null,
                e.question || null,
                e.answer || null,
                e.explanation || null,
                e.options ? JSON.stringify(e.options) : null,
                e.blanks ? JSON.stringify(e.blanks) : null,
              ],
            );
            if (i % 10 === 0 || i === importData.length - 1)
              logPush(
                "[" + (i + 1) + "/" + importData.length + "] " + e.id + " OK",
                "ok",
              );
            inserted++;
          } catch (err) {
            logPush("[" + (i + 1) + "] " + e.id + ": " + err.message, "error");
            errors++;
          }
        }

        try {
          exercises = await sql(
            "SELECT * FROM exercises WHERE level = 'rozszerzony' ORDER BY id",
          );
        } catch (e) {}
        logPush(
          "Import zakonczony! Wstawiono: " + inserted + "  Bledy: " + errors,
          errors === 0 ? "done" : "warn",
        );
        setDBStatus("connected", "Polaczono - " + exercises.length + " zadan");
        btn.disabled = false;
        btn.textContent = "Push do bazy danych";
      }

      function logPush(msg, type) {
        const log = document.getElementById("push-log");
        if (!log) return;
        const colors = {
          info: "var(--text-muted)",
          ok: "var(--success)",
          error: "var(--error)",
          done: "var(--accent)",
          warn: "var(--warn)",
        };
        const div = document.createElement("div");
        div.style.color = colors[type] || "var(--text)";
        div.style.whiteSpace = "pre";
        div.textContent = msg;
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
      }

      Object.assign(window, {
        init,
        showView,
        saveConfig,
        testConnection,
        resetProgress,
        startSession,
        endSession,
        nextExercise,
        checkAnswer,
        checkOption,
        selfGrade,
        renderStats,
        loadSessionHistory,
        loadJSONFile,
        parseJSONPaste,
        loadBuiltinJSON,
        clearImport,
        pushToDB,
      });
    </script>
  </body>
</html>
