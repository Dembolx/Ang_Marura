<!doctype html>
<html lang="pl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Matura Angielski ‚Äî Trener Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>

    /* ====== wszystkie style z oryginalnego projektu ====== */
    :root{--bg:#0d0e12;--surface:#13151c;--surface2:#1c1f2a;--border:#2a2d3a;--accent:#e8c547;--accent2:#4fc3f7;--accent3:#f06292;--text:#e8eaf0;--text-muted:#6b7080;--success:#66bb6a;--error:#ef5350;--warn:#ffa726;--radius:12px}
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font-family:"DM Sans",sans-serif;min-height:100vh}
    /* db status bar */
    #db-status-bar{position:fixed;bottom:1rem;right:1rem;z-index:9999;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:.6rem 1rem;font-size:.78rem;font-family:"DM Mono",monospace;display:flex;align-items:center;gap:.6rem;box-shadow:0 4px 20px rgba(0,0,0,.4);transition:opacity .3s}
    #db-status-bar .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
    #db-status-bar.connected .dot{background:var(--success);box-shadow:0 0 6px var(--success)}
    #db-status-bar.error .dot{background:var(--error)}
    #db-status-bar.loading .dot{background:var(--warn);animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
    /* rest of styles */
    body::before{content:"";position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:0}
    header{position:sticky;top:0;z-index:100;background:rgba(13,14,18,.9);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);padding:0 2rem;display:flex;align-items:center;justify-content:space-between;height:64px}
    .logo{font-family:"Playfair Display",serif;font-size:1.4rem;color:var(--accent);letter-spacing:-.5px}
    .logo span{color:var(--text-muted);font-size:.85rem;font-family:"DM Mono",monospace;display:block;margin-top:-4px}
    nav{display:flex;gap:.5rem}
    .nav-btn{background:none;border:none;color:var(--text-muted);font-family:"DM Sans",sans-serif;font-size:.85rem;padding:.5rem 1rem;border-radius:8px;cursor:pointer;transition:all .2s}
    .nav-btn:hover,.nav-btn.active{background:var(--surface2);color:var(--accent)}
    main{position:relative;z-index:1;max-width:960px;margin:0 auto;padding:2rem 1.5rem}
    .view{display:none}.view.active{display:block}
    .hero{text-align:center;padding:3rem 0 2rem}
    .hero h1{font-family:"Playfair Display",serif;font-size:clamp(2rem,5vw,3.5rem);line-height:1.1;margin-bottom:.75rem}
    .hero h1 em{color:var(--accent);font-style:normal}
    .hero p{color:var(--text-muted);font-size:1.05rem;margin-bottom:2.5rem}
    .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:2.5rem}
    .stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;text-align:center;transition:border-color .2s}
    .stat-card:hover{border-color:var(--accent)}
    .stat-card .val{font-family:"Playfair Display",serif;font-size:2rem;font-weight:700;color:var(--accent);display:block}
    .stat-card .lbl{font-size:.78rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}
    .categories-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem}
    .cat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
    .cat-card::before{content:"";position:absolute;inset:0;background:linear-gradient(135deg,var(--cat-color,#e8c547) 0%,transparent 60%);opacity:.05;transition:opacity .2s}
    .cat-card:hover{border-color:var(--cat-color,var(--accent));transform:translateY(-2px)}
    .cat-card:hover::before{opacity:.1}
    .cat-icon{font-size:2rem;margin-bottom:.75rem}
    .cat-name{font-weight:600;font-size:1.05rem;margin-bottom:.25rem}
    .cat-desc{font-size:.82rem;color:var(--text-muted);margin-bottom:1rem}
    .cat-progress{height:4px;background:var(--border);border-radius:2px;overflow:hidden}
    .cat-progress-fill{height:100%;background:var(--cat-color,var(--accent));border-radius:2px;transition:width .5s}
    .cat-stats{display:flex;gap:1rem;margin-top:.75rem;font-size:.78rem;color:var(--text-muted)}
    .ex-header{display:flex;align-items:center;gap:1rem;margin-bottom:2rem}
    .back-btn{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:.5rem 1rem;border-radius:8px;cursor:pointer;font-family:"DM Sans",sans-serif;font-size:.85rem;transition:all .2s}
    .back-btn:hover{border-color:var(--accent);color:var(--accent)}
    .ex-category-badge{font-family:"DM Mono",monospace;font-size:.78rem;padding:.3rem .8rem;border-radius:20px;background:var(--surface2);border:1px solid var(--border);color:var(--text-muted)}
    .ex-progress-bar{flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden}
    .ex-progress-fill{height:100%;background:var(--accent);border-radius:3px;transition:width .4s}
    .ex-counter{font-family:"DM Mono",monospace;font-size:.85rem;color:var(--text-muted);white-space:nowrap}
    .exercise-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:2rem;margin-bottom:1.5rem;animation:slideIn .3s ease}
    @keyframes slideIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
    .ex-type-badge{display:inline-block;font-family:"DM Mono",monospace;font-size:.72rem;padding:.25rem .6rem;border-radius:4px;background:var(--surface2);color:var(--accent2);border:1px solid var(--border);margin-bottom:1rem;text-transform:uppercase;letter-spacing:.5px}
    .ex-instruction{font-size:.88rem;color:var(--text-muted);margin-bottom:.5rem;font-style:italic}
    .ex-text{font-size:1rem;line-height:1.75;margin-bottom:1.5rem;padding:1rem 1.25rem;background:var(--surface2);border-radius:8px;border-left:3px solid var(--accent2)}
    .ex-question{font-size:1.05rem;font-weight:500;margin-bottom:1.25rem;line-height:1.6}
    .options{display:flex;flex-direction:column;gap:.6rem}
    .option-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:.85rem 1.1rem;border-radius:8px;cursor:pointer;text-align:left;font-family:"DM Sans",sans-serif;font-size:.95rem;transition:all .15s;display:flex;align-items:center;gap:.75rem}
    .option-btn:hover:not(:disabled){border-color:var(--accent);background:rgba(232,197,71,.06)}
    .option-btn .opt-letter{font-family:"DM Mono",monospace;font-size:.8rem;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:var(--border);color:var(--text-muted);flex-shrink:0}
    .option-btn.correct{border-color:var(--success);background:rgba(102,187,106,.1)}
    .option-btn.correct .opt-letter{background:var(--success);color:#000}
    .option-btn.wrong{border-color:var(--error);background:rgba(239,83,80,.1)}
    .option-btn.wrong .opt-letter{background:var(--error);color:#fff}
    .option-btn:disabled{cursor:default;opacity:.7}
    .ex-input{width:100%;padding:.85rem 1.1rem;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:"DM Mono",monospace;font-size:.95rem;transition:border-color .2s;outline:none}
    .ex-input:focus{border-color:var(--accent2)}
    .ex-input.correct{border-color:var(--success)}.ex-input.wrong{border-color:var(--error)}
    textarea.ex-input{resize:vertical;min-height:140px;line-height:1.6;font-family:"DM Sans",sans-serif}
    .fill-blanks{display:flex;flex-direction:column;gap:.75rem}
    .blank-row{display:flex;align-items:center;gap:.75rem;font-size:.95rem}
    .blank-num{font-family:"DM Mono",monospace;font-size:.78rem;color:var(--accent);min-width:28px}
    .blank-input{background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:"DM Mono",monospace;font-size:.95rem;padding:.5rem .75rem;outline:none;transition:border-color .2s;min-width:180px}
    .blank-input:focus{border-color:var(--accent2)}.blank-input.correct{border-color:var(--success)}.blank-input.wrong{border-color:var(--error)}
    .blank-hint{font-size:.82rem;color:var(--text-muted)}
    .feedback-box{padding:1rem 1.25rem;border-radius:8px;margin-top:1.25rem;font-size:.92rem;line-height:1.6;display:none;animation:fadeIn .2s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .feedback-box.correct{background:rgba(102,187,106,.1);border:1px solid rgba(102,187,106,.3);color:var(--success)}
    .feedback-box.wrong{background:rgba(239,83,80,.1);border:1px solid rgba(239,83,80,.3);color:#ff8a80}
    .feedback-box strong{display:block;margin-bottom:.25rem}
    .action-row{display:flex;gap:.75rem;margin-top:1.25rem;justify-content:flex-end}
    .btn{padding:.75rem 1.5rem;border-radius:8px;font-family:"DM Sans",sans-serif;font-size:.92rem;font-weight:500;cursor:pointer;border:none;transition:all .2s}
    .btn-primary{background:var(--accent);color:#000}.btn-primary:hover{background:#f0d060}
    .btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}.btn-secondary:hover{border-color:var(--accent);color:var(--accent)}
    .btn:disabled{opacity:.4;cursor:default}
    .session-results{text-align:center;padding:3rem 2rem;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius)}
    .session-score{font-family:"Playfair Display",serif;font-size:5rem;font-weight:900;color:var(--accent);line-height:1;margin:1rem 0}
    .session-score span{font-size:2rem;color:var(--text-muted)}
    .session-breakdown{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin:2rem 0}
    .sb-item{text-align:center}.sb-val{font-family:"Playfair Display",serif;font-size:1.8rem;font-weight:700}
    .sb-lbl{font-size:.78rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}
    /* DB Config Panel */
    .db-config{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;margin-bottom:1.5rem}
    .db-config h3{font-family:"DM Mono",monospace;font-size:.82rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:1rem}
    .db-input{width:100%;padding:.7rem 1rem;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--accent2);font-family:"DM Mono",monospace;font-size:.82rem;outline:none;transition:border-color .2s;margin-bottom:.75rem}
    .db-input:focus{border-color:var(--accent2)}
    @media(max-width:600px){.stats-row{grid-template-columns:repeat(2,1fr)}}
    ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}::-webkit-scrollbar-thumb:hover{background:var(--text-muted)}
  

    /* ====== MATURA PODSTAWOWA badge ====== */
    .level-badge { display:inline-block; font-family:'DM Mono',monospace; font-size:.7rem; padding:.2rem .55rem; border-radius:4px; margin-left:.5rem; vertical-align:middle; }
    .level-r { background:rgba(232,197,71,.15); color:var(--accent); border:1px solid rgba(232,197,71,.3); }
    .level-p { background:rgba(79,195,247,.15); color:var(--accent2); border:1px solid rgba(79,195,247,.3); }

    /* ====== TEORIA SECTION ====== */
    .theory-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:1rem; }
    .theory-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:1.5rem; cursor:pointer; transition:all .2s; }
    .theory-card:hover { border-color:var(--cat-color,var(--accent)); transform:translateY(-2px); }
    .theory-card .t-icon { font-size:2rem; margin-bottom:.6rem; }
    .theory-card .t-title { font-weight:600; font-size:1rem; margin-bottom:.25rem; }
    .theory-card .t-desc { font-size:.8rem; color:var(--text-muted); }

    .theory-article { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:2rem; display:none; animation:slideIn .3s ease; }
    .theory-article.active { display:block; }
    .theory-article h2 { font-family:'Playfair Display',serif; font-size:1.5rem; margin-bottom:1.5rem; color:var(--accent); }
    .theory-article h3 { font-family:'DM Mono',monospace; font-size:.85rem; text-transform:uppercase; letter-spacing:.5px; color:var(--accent2); margin:1.5rem 0 .75rem; border-bottom:1px solid var(--border); padding-bottom:.4rem; }
    .theory-article p { line-height:1.8; margin-bottom:1rem; color:var(--text); font-size:.95rem; }
    .theory-article ul, .theory-article ol { padding-left:1.5rem; margin-bottom:1rem; }
    .theory-article li { line-height:1.8; font-size:.92rem; color:var(--text); margin-bottom:.25rem; }
    .theory-article .example { background:var(--surface2); border-left:3px solid var(--accent); border-radius:0 8px 8px 0; padding:.75rem 1rem; margin:.75rem 0; font-family:'DM Mono',monospace; font-size:.85rem; line-height:1.7; }
    .theory-article .hack { background:rgba(232,197,71,.07); border:1px solid rgba(232,197,71,.2); border-radius:8px; padding:.85rem 1rem; margin:.75rem 0; }
    .theory-article .hack::before { content:"üí° HACK: "; color:var(--accent); font-weight:600; font-size:.82rem; }
    .theory-article table { width:100%; border-collapse:collapse; font-size:.85rem; margin:1rem 0; }
    .theory-article th { background:var(--surface2); padding:.6rem .9rem; text-align:left; font-family:'DM Mono',monospace; font-size:.75rem; text-transform:uppercase; color:var(--text-muted); border-bottom:2px solid var(--border); }
    .theory-article td { padding:.6rem .9rem; border-bottom:1px solid rgba(42,45,58,.6); }
    .theory-article tr:hover td { background:rgba(255,255,255,.02); }

    /* ====== HISTORIA ZADA≈É ====== */
    .history-item { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:1.25rem; margin-bottom:.75rem; transition:border-color .2s; }
    .history-item:hover { border-color:var(--border-hover,var(--accent)); }
    .history-item.correct-item { border-left:3px solid var(--success); }
    .history-item.wrong-item { border-left:3px solid var(--error); }
    .history-item .hi-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; }
    .history-item .hi-id { font-family:'DM Mono',monospace; font-size:.72rem; color:var(--text-muted); }
    .history-item .hi-result { font-size:.78rem; font-weight:600; }
    .history-item .hi-question { font-size:.88rem; color:var(--text); margin-bottom:.5rem; line-height:1.5; }
    .history-item .hi-answer { font-size:.82rem; }
    .history-item details summary { font-family:'DM Mono',monospace; font-size:.75rem; color:var(--accent2); cursor:pointer; margin-top:.5rem; }
    .history-item details p { margin-top:.5rem; font-size:.82rem; color:var(--text-muted); line-height:1.6; }

    /* ====== POZIOM SWITCH ====== */
    .level-switch { display:flex; gap:.5rem; background:var(--surface2); border-radius:10px; padding:.3rem; margin-bottom:1.5rem; width:fit-content; }
    .level-switch button { padding:.45rem 1.25rem; border:none; border-radius:7px; font-family:'DM Sans',sans-serif; font-size:.85rem; cursor:pointer; transition:all .2s; background:none; color:var(--text-muted); }
    .level-switch button.active { background:var(--surface); color:var(--text); box-shadow:0 2px 8px rgba(0,0,0,.3); }

    /* ====== TOOLTIPS / HINT BOXES ====== */
    .hint-pill { display:inline-block; background:rgba(79,195,247,.1); border:1px solid rgba(79,195,247,.25); color:var(--accent2); font-size:.78rem; padding:.2rem .6rem; border-radius:20px; font-family:'DM Mono',monospace; margin:.2rem; }

    @media(max-width:600px){ .stats-row{grid-template-columns:repeat(2,1fr)} .level-switch{width:100%} }

</style>

<body>
<!-- DB STATUS -->
<div id="db-status-bar" class="loading"><div class="dot"></div><span id="db-status-text">≈ÅƒÖczenie z bazƒÖ...</span></div>

<header>
  <div class="logo">MATURA <em style="color:var(--accent)">EN</em><span id="logo-sub">Trener Angielskiego</span></div>
  <nav>
    <button class="nav-btn active" onclick="showView('home')">üè† Start</button>
    <button class="nav-btn" onclick="showView('stats')">üìä Postƒôpy</button>
    <button class="nav-btn" onclick="showView('history')">üìã Historia</button>
    <button class="nav-btn" onclick="showView('theory')">üìñ Teoria</button>
    <button class="nav-btn" onclick="showView('import')">üì• Import</button>
    <button class="nav-btn" onclick="showView('db-config')">üóÑÔ∏è Baza</button>
  </nav>
</header>

<main>

<!-- ========== HOME VIEW ========== -->
<div id="view-home" class="view active">
  <div class="hero">
    <h1>Zdaj maturƒô z <em>angielskiego</em></h1>
    <p>Postƒôpy zapisywane w chmurze ‚Äî Neon PostgreSQL</p>
  </div>

  <!-- Level switch -->
  <div class="level-switch" id="level-switch">
    <button onclick="setLevel('rozszerzony')" id="btn-lvl-r" class="active">Rozszerzony (PR)</button>
    <button onclick="setLevel('podstawowy')" id="btn-lvl-p">Podstawowy (PP)</button>
  </div>

  <div class="stats-row" id="global-stats">
    <div class="stat-card"><span class="val" id="stat-total">‚Äî</span><span class="lbl">Zada≈Ñ w bazie</span></div>
    <div class="stat-card"><span class="val" id="stat-done">‚Äî</span><span class="lbl">Zrobionych</span></div>
    <div class="stat-card"><span class="val" id="stat-score">‚Äî</span><span class="lbl">Skuteczno≈õƒá</span></div>
    <div class="stat-card"><span class="val" id="stat-streak">‚Äî</span><span class="lbl">Dni z rzƒôdu üî•</span></div>
  </div>

  <div class="categories-grid" id="categories-grid">
    <div style="grid-column:1/-1;text-align:center;color:var(--text-muted);padding:3rem 0">
      <div style="font-size:2rem;margin-bottom:.5rem">‚è≥</div>≈Åadowanie kategorii...
    </div>
  </div>
</div>

<!-- ========== EXERCISE VIEW ========== -->
<div id="view-exercise" class="view">
  <div class="ex-header">
    <button class="back-btn" onclick="endSession()">‚Üê Wr√≥ƒá</button>
    <span class="ex-category-badge" id="ex-cat-name">‚Äî</span>
    <span id="ex-level-badge" class="level-badge level-r">PR</span>
    <div class="ex-progress-bar"><div class="ex-progress-fill" id="ex-progress-fill" style="width:0%"></div></div>
    <span class="ex-counter" id="ex-counter">0/0</span>
  </div>
  <div id="exercise-area"></div>
</div>

<!-- ========== STATS VIEW ========== -->
<div id="view-stats" class="view">
  <div style="font-family:'Playfair Display',serif;font-size:1.6rem;margin-bottom:1.5rem">üìä Twoje postƒôpy</div>
  <div id="stats-content"><div style="color:var(--text-muted);text-align:center;padding:3rem">≈Åadowanie statystyk...</div></div>
</div>

<!-- ========== HISTORIA ZADA≈É VIEW ========== -->
<div id="view-history" class="view">
  <div style="font-family:'Playfair Display',serif;font-size:1.6rem;margin-bottom:.4rem">üìã Historia zada≈Ñ</div>
  <div style="color:var(--text-muted);font-size:.85rem;margin-bottom:1.5rem">Ostatnie 30 odpowiedzi ‚Äî sprawd≈∫ gdzie pope≈Çni≈Çe≈õ b≈ÇƒÖd</div>

  <div style="display:flex;gap:.75rem;margin-bottom:1.5rem;flex-wrap:wrap">
    <button class="btn btn-secondary" onclick="filterHistory('all')" id="hf-all" style="border-color:var(--accent);color:var(--accent)">Wszystkie</button>
    <button class="btn btn-secondary" onclick="filterHistory('wrong')" id="hf-wrong">‚ùå B≈Çƒôdne</button>
    <button class="btn btn-secondary" onclick="filterHistory('correct')" id="hf-correct">‚úÖ Poprawne</button>
  </div>

  <div id="history-list"><div style="color:var(--text-muted);text-align:center;padding:3rem">≈Åadowanie historii...</div></div>
</div>

<!-- ========== TEORIA VIEW ========== -->
<div id="view-theory" class="view">
  <div style="font-family:'Playfair Display',serif;font-size:1.6rem;margin-bottom:.4rem">üìñ Teoria i Hacki</div>
  <div style="color:var(--text-muted);font-size:.85rem;margin-bottom:1.75rem">Wszystko czego potrzebujesz do matury z angielskiego</div>

  <div id="theory-grid-wrap">
    <div class="theory-grid" id="theory-grid"></div>
  </div>
  <div id="theory-article-wrap" style="display:none">
    <button class="back-btn" style="margin-bottom:1.5rem" onclick="closeTheory()">‚Üê Powr√≥t do teorii</button>
    <div id="theory-article" class="theory-article active"></div>
  </div>
</div>

<!-- ========== IMPORT VIEW ========== -->
<div id="view-import" class="view">
  <div style="font-family:'Playfair Display',serif;font-size:1.6rem;margin-bottom:.4rem">üì• Import zada≈Ñ z JSON</div>
  <div style="color:var(--text-muted);font-size:.85rem;margin-bottom:1.75rem">Wgraj plik JSON ‚Äî zadania zostanƒÖ dodane do bazy danych</div>

  <div class="db-config">
    <h3>// 1. Wybierz ≈∫r√≥d≈Ço</h3>
    <div style="display:flex;gap:.75rem;flex-wrap:wrap;margin-bottom:1rem">
      <label class="btn btn-primary" style="cursor:pointer;display:inline-flex;align-items:center;gap:.5rem">
        üìÇ Wczytaj plik JSON
        <input type="file" id="json-file-input" accept=".json" style="display:none" onchange="loadJSONFile(event)">
      </label>
      <button class="btn btn-secondary" onclick="toggleJSONPaste()">üìã Wklej JSON</button>
    </div>
    <textarea id="json-paste" class="ex-input" style="display:none;min-height:160px;font-family:'DM Mono',monospace;font-size:.78rem" placeholder='[{"id":"p001","category":"reading","level":"podstawowy",...}]' oninput="parseJSONPaste()"></textarea>
  </div>

  <div class="db-config" id="import-preview" style="display:none">
    <h3>// 2. PodglƒÖd importu</h3>
    <div id="import-summary" style="font-family:'DM Mono',monospace;font-size:.82rem;line-height:2;margin-bottom:1rem;white-space:pre"></div>
    <div id="import-table-wrap" style="overflow-x:auto;max-height:320px;overflow-y:auto"></div>
  </div>

  <div class="db-config" id="import-action" style="display:none">
    <h3>// 3. Wykonaj import</h3>
    <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap">
      <button class="btn btn-primary" id="push-btn" onclick="pushToDB()">üöÄ Push do bazy</button>
      <button class="btn btn-secondary" onclick="clearImport()">üóë Wyczy≈õƒá</button>
      <label style="display:flex;align-items:center;gap:.5rem;font-size:.85rem;color:var(--text-muted);cursor:pointer">
        <input type="checkbox" id="skip-duplicates" checked style="accent-color:var(--accent)"> Pomi≈Ñ duplikaty
      </label>
    </div>
    <div id="push-log" style="margin-top:1rem;font-family:'DM Mono',monospace;font-size:.78rem;line-height:1.8;max-height:200px;overflow-y:auto"></div>
  </div>
</div>

<!-- ========== DB CONFIG VIEW ========== -->
<div id="view-db-config" class="view">
  <div style="font-family:'Playfair Display',serif;font-size:1.6rem;margin-bottom:.4rem">üóÑÔ∏è Konfiguracja Bazy</div>
  <div style="color:var(--text-muted);font-size:.85rem;margin-bottom:1.75rem">Neon PostgreSQL ‚Äî Serverless Driver</div>

  <div class="db-config">
    <h3>// Dane po≈ÇƒÖczenia</h3>
    <div style="font-family:'DM Mono',monospace;font-size:.78rem;color:var(--text-muted);margin-bottom:1rem;line-height:1.7">
      Host: <span style="color:var(--accent2)">ep-old-moon-agtpam3x-pooler.c-2.eu-central-1.aws.neon.tech</span><br>
      Baza: <span style="color:var(--accent2)">neondb</span>
    </div>
    <label style="font-size:.82rem;color:var(--text-muted);display:block;margin-bottom:.25rem">User ID</label>
    <input class="db-input" id="cfg-user" type="text" placeholder="np. jan_kowalski"/>
    <div style="display:flex;gap:.75rem;margin-top:.5rem;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="saveConfig()">üíæ Zapisz</button>
      <button class="btn btn-secondary" onclick="testConnection()">üîå Test</button>
      <button class="btn btn-secondary" onclick="resetProgress()">üóë Reset postƒôp√≥w</button>
    </div>
    <div id="cfg-msg" style="margin-top:.75rem;font-size:.85rem"></div>
  </div>

  <div class="db-config">
    <h3>// Status</h3>
    <div id="conn-details" style="font-family:'DM Mono',monospace;font-size:.78rem;color:var(--text-muted);line-height:1.8">Kliknij Test po≈ÇƒÖczenia.</div>
  </div>

  <div class="db-config">
    <h3>// Ostatnie 10 sesji</h3>
    <div id="session-history-list" style="color:var(--text-muted);font-size:.85rem">≈Åadowanie...</div>
  </div>
</div>

</main>

<script type="module">
import { neon } from 'https://esm.sh/@neondatabase/serverless@1.0.0';

const CONNECTION_STRING = 'postgresql://neondb_owner:npg_w4bAGP3HiZYa@ep-old-moon-agtpam3x-pooler.c-2.eu-central-1.aws.neon.tech/neondb?sslmode=require';
const _db = neon(CONNECTION_STRING);

const CONFIG = {
  get user() { return localStorage.getItem('neon_user') || 'default'; },
};

async function sql(query, params = []) {
  const result = await _db.query(query, params);
  if (Array.isArray(result)) return result;
  return result.rows ?? result;
}

function setDBStatus(state, text) {
  const bar = document.getElementById('db-status-bar');
  const txt = document.getElementById('db-status-text');
  bar.className = state;
  txt.textContent = text;
}

// =====================================================
// STATE
// =====================================================
let exercises    = [];
let progress     = {};
let streak       = 0;
let currentLevel = localStorage.getItem('matura_level') || 'rozszerzony';
let answerHistory = []; // {exerciseId, isCorrect, userAnswer, timestamp}

const CATEGORIES = {
  // Rozszerzone
  reading:        { name:'Rozumienie Tekst√≥w',   icon:'üìñ', color:'#4fc3f7', level:'rozszerzony' },
  grammar:        { name:'Gramatyka',             icon:'üîß', color:'#f06292', level:'rozszerzony' },
  vocabulary:     { name:'S≈Çownictwo',            icon:'üìö', color:'#a5d6a7', level:'rozszerzony' },
  use_of_english: { name:'Use of English',        icon:'‚öôÔ∏è', color:'#ffb74d', level:'rozszerzony' },
  writing:        { name:'Wypowied≈∫ Pisemna',     icon:'‚úçÔ∏è', color:'#ce93d8', level:'rozszerzony' },
  listening_text: { name:'Tekst S≈Çuchany',        icon:'üéß', color:'#80cbc4', level:'rozszerzony' },
  
  // Podstawowe
  basic_grammar:    { name:'Gramatyka',           icon:'üîß', color:'#4caf50', level:'podstawowy' },
  basic_vocabulary: { name:'S≈Çownictwo',          icon:'üìñ', color:'#26a69a', level:'podstawowy' },
  basic_reading:    { name:'Czytanie',            icon:'üì∞', color:'#42a5f5', level:'podstawowy' },
  basic_listening:  { name:'S≈Çuchanie',           icon:'üéß', color:'#7e57c2', level:'podstawowy' },
  basic_writing:    { name:'Pisanie',              icon:'‚úçÔ∏è', color:'#ef5350', level:'podstawowy' },
};

const SESSION = { exercises:[], current:0, correct:0, wrong:0, startTime:null, category:null, answered:false };

function setLevel(lvl) {
  currentLevel = lvl;
  localStorage.setItem('matura_level', lvl);
  document.getElementById('btn-lvl-r').className = lvl==='rozszerzony' ? 'active' : '';
  document.getElementById('btn-lvl-p').className = lvl==='podstawowy' ? 'active' : '';
  init();
}

// =====================================================
// INIT
// =====================================================
async function init() {
  setDBStatus('loading','≈ÅƒÖczenie z bazƒÖ...');
  try {
    exercises = await sql('SELECT * FROM exercises WHERE level=$1 ORDER BY id',[currentLevel]);
    const prog = await sql('SELECT * FROM user_progress WHERE user_id=$1',[CONFIG.user]);
    progress = {};
    prog.forEach(p => { progress[p.exercise_id] = {attempts:p.attempts, correct:p.correct}; });

    try {
      const s = await sql('SELECT streak_count FROM user_streak WHERE user_id=$1',[CONFIG.user]);
      streak = s[0]?.streak_count || 0;
    } catch(e) { streak = 0; }

    // Load answer history from DB
    try {
      const h = await sql(`SELECT ah.*, e.question, e.answer, e.explanation, e.category_id, e.type
        FROM answer_history ah
        LEFT JOIN exercises e ON e.id = ah.exercise_id
        WHERE ah.user_id=$1 ORDER BY ah.answered_at DESC LIMIT 30`,[CONFIG.user]);
      answerHistory = h;
    } catch(e) {
      answerHistory = [];
    }

    setDBStatus('connected', `Po≈ÇƒÖczono ¬∑ ${exercises.length} zada≈Ñ ¬∑ ${currentLevel==='rozszerzony'?'PR':'PP'}`);
    renderHome();
  } catch(e) {
    setDBStatus('error','B≈ÇƒÖd po≈ÇƒÖczenia');
    showFallback(e.message);
  }
}

function showFallback(err) {
  document.getElementById('categories-grid').innerHTML = `
  <div style="grid-column:1/-1;background:rgba(239,83,80,.08);border:1px solid rgba(239,83,80,.25);border-radius:12px;padding:2rem;text-align:center">
    <div style="font-size:2rem;margin-bottom:.75rem">‚ö†Ô∏è</div>
    <div style="font-weight:600;color:var(--error);margin-bottom:.5rem">Brak po≈ÇƒÖczenia z bazƒÖ</div>
    <div style="color:var(--text-muted);font-size:.85rem;margin-bottom:1rem">${err}</div>
    <button class="btn btn-primary" onclick="init()">üîÑ Spr√≥buj ponownie</button>
  </div>`;
}

// =====================================================
// HOME
// =====================================================

// =====================================================
// HOME
// =====================================================
function renderHome() {
  const total = exercises.length;
  const done  = Object.keys(progress).length;
  const allAtt  = Object.values(progress).reduce((a,p)=>a+p.attempts,0);
  const allCorr = Object.values(progress).reduce((a,p)=>a+p.correct,0);
  const score = allAtt>0 ? Math.round(allCorr/allAtt*100) : 0;

  document.getElementById('stat-total').textContent  = total;
  document.getElementById('stat-done').textContent   = done;
  document.getElementById('stat-score').textContent  = score+'%';
  document.getElementById('stat-streak').textContent = streak;

  const grid = document.getElementById('categories-grid');
  grid.innerHTML = '';
  
  // Filtruj kategorie na podstawie wybranego poziomu
  const filteredCategories = Object.entries(CATEGORIES).filter(([key, cat]) => {
    // Dla poziomu rozszerzonego poka≈º tylko kategorie bez prefiksu 'basic_'
    if (currentLevel === 'rozszerzony') {
      return !key.startsWith('basic_');
    } 
    // Dla poziomu podstawowego poka≈º tylko kategorie z prefiksem 'basic_'
    else {
      return key.startsWith('basic_');
    }
  });

  if (filteredCategories.length === 0) {
    grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:var(--text-muted);padding:3rem 0">
      <div style="font-size:2rem;margin-bottom:.5rem">üì≠</div>
      Brak kategorii dla poziomu ${currentLevel === 'rozszerzony' ? 'rozszerzonego' : 'podstawowego'}
    </div>`;
    return;
  }

  filteredCategories.forEach(([key, cat]) => {
    const catExs  = exercises.filter(e=>e.category_id===key);
    const catDone = catExs.filter(e=>progress[e.id]).length;
    const catAtt  = catExs.reduce((a,e)=>a+(progress[e.id]?.attempts||0),0);
    const catCorr = catExs.reduce((a,e)=>a+(progress[e.id]?.correct||0),0);
    const catScore= catAtt>0 ? Math.round(catCorr/catAtt*100) : 0;
    const pct     = catExs.length>0 ? Math.round(catDone/catExs.length*100) : 0;

    const card = document.createElement('div');
    card.className='cat-card'; card.style.setProperty('--cat-color',cat.color);
    card.innerHTML=`
      <div class="cat-icon">${cat.icon}</div>
      <div class="cat-name">${cat.name}</div>
      <div class="cat-desc">${catExs.length} zada≈Ñ ¬∑ ${currentLevel==='rozszerzony'?'Poziom rozszerzony':'Poziom podstawowy'}</div>
      <div class="cat-progress"><div class="cat-progress-fill" style="width:${pct}%;background:${cat.color}"></div></div>
      <div class="cat-stats">
        <span>${catDone}/${catExs.length} zrobionych</span>
        <span style="color:${catScore>=70?'var(--success)':catScore>=50?'var(--warn)':'var(--text-muted)'}">${catScore}% trafnych</span>
      </div>`;
    card.onclick=()=>startSession(key);
    grid.appendChild(card);
  });
}

// =====================================================
// SESSION & EXERCISES
// =====================================================
function startSession(category) {
  const all = exercises.filter(e=>e.category_id===category);
  if (!all.length) { alert('Brak zada≈Ñ w tej kategorii dla poziomu ' + (currentLevel==='rozszerzony'?'rozszerzonego':'podstawowego') + '.'); return; }
  all.sort((a,b)=>{
    const pa=progress[a.id],pb=progress[b.id];
    if(!pa&&!pb) return 0; if(!pa) return -1; if(!pb) return 1;
    const ra=pa.attempts>0?pa.correct/pa.attempts:0, rb=pb.attempts>0?pb.correct/pb.attempts:0;
    return ra-rb;
  });
  Object.assign(SESSION,{exercises:all,current:0,correct:0,wrong:0,startTime:Date.now(),category,answered:false});
  showView('exercise');
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('ex-cat-name').textContent = CATEGORIES[category]?.name||category;
  const lb = document.getElementById('ex-level-badge');
  if(lb){ lb.textContent=currentLevel==='rozszerzony'?'PR':'PP'; lb.className='level-badge '+(currentLevel==='rozszerzony'?'level-r':'level-p'); }
  renderExercise();
}

function renderExercise() {
  const ex = SESSION.exercises[SESSION.current];
  if (!ex) { showSessionResults(); return; }
  SESSION.answered = false;
  const total=SESSION.exercises.length, idx=SESSION.current+1;
  document.getElementById('ex-counter').textContent = idx+'/'+total;
  document.getElementById('ex-progress-fill').style.width = ((idx-1)/total*100)+'%';

  const TYPE_LABELS={multiple_choice:'Wielokrotny wyb√≥r',fill_blank:'Uzupe≈Çnij luki',true_false_ng:'Prawda / Fa≈Çsz / Brak',sentence_transform:'Transformacja zda≈Ñ',essay:'Wypowied≈∫ pisemna',email:'E-mail',open_answer:'Odpowied≈∫ otwarta'};
  const options = ex.options ? (typeof ex.options==='string'?JSON.parse(ex.options):ex.options) : null;
  const blanks  = ex.blanks  ? (typeof ex.blanks==='string' ?JSON.parse(ex.blanks) :ex.blanks)  : null;

  // Build hint section for PP
  let hintHTML = '';
  if (currentLevel==='podstawowy') {
    hintHTML = `<div style="background:rgba(79,195,247,.06);border:1px solid rgba(79,195,247,.2);border-radius:8px;padding:.6rem .9rem;margin-bottom:1rem;font-size:.8rem;color:var(--accent2)">
      üí° <strong>Wskaz√≥wka:</strong> ${getTaskHint(ex.type, ex.category_id)}
    </div>`;
  }

  let inputHTML='';
  if(ex.type==='multiple_choice'||ex.type==='true_false_ng'){
    inputHTML='<div class="options">'+(options||[]).map((o,i)=>{
      const letter=String.fromCharCode(65+i);
      return `<button class="option-btn" onclick="checkOption(this,'${letter}','${ex.answer}')" data-letter="${letter}"><span class="opt-letter">${letter}</span>${o.replace(/^[A-D]\.\s*/,'')}</button>`;
    }).join('')+'</div>';
  } else if(ex.type==='fill_blank'&&blanks?.length){
    inputHTML='<div class="fill-blanks">'+blanks.map(b=>`
      <div class="blank-row">
        <span class="blank-num">${b.num}.</span>
        <input class="blank-input" type="text" id="blank-${b.num}" placeholder="${b.hint||'odpowied≈∫'}" autocomplete="off">
        <span class="blank-hint" id="blank-hint-${b.num}"></span>
      </div>`).join('')+'</div>';
  } else if(ex.type==='fill_blank'){
    inputHTML=`<input class="ex-input" type="text" id="single-input" placeholder="Wpisz odpowied≈∫..." autocomplete="off">`;
  } else if(ex.type==='sentence_transform'||ex.type==='open_answer'){
    inputHTML=`<input class="ex-input" type="text" id="single-input" placeholder="Wpisz odpowied≈∫ (2‚Äì5 wyraz√≥w)..." autocomplete="off">`;
  } else if(ex.type==='essay'||ex.type==='email'){
    inputHTML=`<textarea class="ex-input" id="essay-input" placeholder="Napisz swojƒÖ wypowied≈∫ tutaj..."></textarea>`;
  }

  document.getElementById('exercise-area').innerHTML=`
  <div class="exercise-card">
    <span class="ex-type-badge">${TYPE_LABELS[ex.type]||ex.type}${ex.year?' ¬∑ '+ex.year:''}</span>
    ${hintHTML}
    ${ex.instruction?`<div class="ex-instruction">${ex.instruction}</div>`:''}
    ${ex.text?`<div class="ex-text">${ex.text.replace(/\n/g,'<br>')}</div>`:''}
    <div class="ex-question">${(ex.question||'').replace(/\n/g,'<br>')}</div>
    ${inputHTML}
    <div class="feedback-box" id="feedback-box"></div>
    <div class="action-row">
      ${ex.type==='essay'||ex.type==='email'
        ?`<button class="btn btn-secondary" onclick="selfGrade(true)">‚úÖ Poprawne</button>
           <button class="btn btn-secondary" onclick="selfGrade(false)" style="border-color:var(--error);color:var(--error)">‚ùå Do poprawy</button>`
        :`<button class="btn btn-primary" id="check-btn" onclick="checkAnswer()">Sprawd≈∫</button>`}
      <button class="btn btn-secondary" id="next-btn" onclick="nextExercise()" style="display:none">Nastƒôpne ‚Üí</button>
    </div>
  </div>`;
}

function getTaskHint(type, cat) {
  const hints = {
    multiple_choice: 'Przeczytaj uwa≈ºnie wszystkie opcje. Wyeliminuj b≈Çƒôdne odpowiedzi.',
    true_false_ng: 'NOT GIVEN = informacja NIE POJAWIA SIƒò w tek≈õcie. Nie wnioskuj!',
    fill_blank: 'Sprawd≈∫ kontekst zdania. Zwr√≥ƒá uwagƒô na formƒô gramatycznƒÖ.',
    sentence_transform: 'Zmie≈Ñ formƒô, zachowaj znaczenie. U≈ºyj 2‚Äì5 wyraz√≥w z podanym s≈Çowem.',
    essay: 'Wstƒôp ‚Üí 2 akapity z argumentami ‚Üí zako≈Ñczenie z w≈ÇasnƒÖ opiniƒÖ.',
    email: 'Formalny: Dear Sir/Madam, Yours faithfully. Nieformalny: Hi, Take care!'
  };
  return hints[type] || 'Przeczytaj uwa≈ºnie pytanie i odpowiedz precyzyjnie.';
}

function checkOption(btn, letter, correct) {
  if(SESSION.answered) return;
  SESSION.answered=true;
  const ex=SESSION.exercises[SESSION.current];
  const isCorrect=letter===correct;
  document.querySelectorAll('.option-btn').forEach(b=>{
    b.disabled=true;
    if(b.dataset.letter===correct) b.classList.add('correct');
    if(b===btn&&!isCorrect) b.classList.add('wrong');
  });
  showFeedback(isCorrect,ex.explanation,correct,letter);
  recordResult(ex.id,isCorrect,letter);
  document.getElementById('next-btn').style.display='inline-flex';
}

function checkAnswer() {
  if(SESSION.answered) return;
  const ex=SESSION.exercises[SESSION.current];
  const blanks=ex.blanks?(typeof ex.blanks==='string'?JSON.parse(ex.blanks):ex.blanks):null;
  let isCorrect=false, userAnswer='';

  if(ex.type==='fill_blank'&&blanks?.length){
    let allOk=true;
    blanks.forEach(b=>{
      const inp=document.getElementById('blank-'+b.num);
      if(!inp) return;
      const ok=inp.value.trim().toLowerCase()===b.answer.toLowerCase();
      inp.classList.add(ok?'correct':'wrong');
      const hint=document.getElementById('blank-hint-'+b.num);
      if(hint) hint.textContent=ok?'‚úì':'‚úó '+b.answer;
      if(!ok) allOk=false;
    });
    isCorrect=allOk;
    userAnswer=blanks.map(b=>document.getElementById('blank-'+b.num)?.value||'').join(' | ');
  } else {
    const inp=document.getElementById('single-input');
    if(inp){
      userAnswer=inp.value.trim();
      isCorrect=userAnswer.toLowerCase()===ex.answer?.toLowerCase();
      inp.classList.add(isCorrect?'correct':'wrong');
      inp.disabled=true;
    }
  }
  SESSION.answered=true;
  showFeedback(isCorrect,ex.explanation,ex.answer,userAnswer);
  recordResult(ex.id,isCorrect,userAnswer);
  const cb=document.getElementById('check-btn');
  if(cb) cb.style.display='none';
  document.getElementById('next-btn').style.display='inline-flex';
}

function selfGrade(passed) {
  SESSION.answered=true;
  const ex=SESSION.exercises[SESSION.current];
  showFeedback(passed,ex.explanation||'Oce≈Ñ strukturƒô, sp√≥jno≈õƒá i poprawno≈õƒá jƒôzykowƒÖ.',null,passed?'correct':'incorrect');
  recordResult(ex.id,passed,passed?'self:correct':'self:incorrect');
  document.getElementById('next-btn').style.display='inline-flex';
}

function showFeedback(isCorrect,explanation,correct,userAnswer) {
  const fb=document.getElementById('feedback-box');
  fb.className='feedback-box '+(isCorrect?'correct':'wrong');
  fb.style.display='block';
  fb.innerHTML=`<strong>${isCorrect?'‚úÖ Poprawnie!':'‚ùå Niepoprawnie'}</strong>
  ${!isCorrect&&correct?`<div>Poprawna odpowied≈∫: <strong>${correct}</strong>${userAnswer?` (Twoja: ${userAnswer})`:''}</div>`:''}
  ${explanation?`<div style="margin-top:.5rem;color:var(--text-muted);font-size:.88rem">${explanation}</div>`:''}`;
  if(isCorrect) SESSION.correct++; else SESSION.wrong++;
}

async function recordResult(exerciseId, isCorrect, userAnswer='') {
  const cur=progress[exerciseId]||{attempts:0,correct:0};
  const newAtt=cur.attempts+1, newCorr=cur.correct+(isCorrect?1:0);
  progress[exerciseId]={attempts:newAtt,correct:newCorr};

  // Save progress
  try {
    await sql(`INSERT INTO user_progress(user_id,exercise_id,attempts,correct,last_seen) VALUES($1,$2,$3,$4,NOW())
      ON CONFLICT(user_id,exercise_id) DO UPDATE SET attempts=$3,correct=$4,last_seen=NOW()`,
      [CONFIG.user,exerciseId,newAtt,newCorr]);
  } catch(e){ console.warn('progress:',e.message); }

  // Save to answer_history
  try {
    await sql(`INSERT INTO answer_history(user_id,exercise_id,is_correct,user_answer,answered_at)
      VALUES($1,$2,$3,$4,NOW())`,
      [CONFIG.user,exerciseId,isCorrect,String(userAnswer).substring(0,500)]);
  } catch(e){ console.warn('history:',e.message); }

  // Update streak
  try {
    const today=new Date().toISOString().slice(0,10);
    await sql(`INSERT INTO user_streak(user_id,last_date,streak_count) VALUES($1,$2,1)
      ON CONFLICT(user_id) DO UPDATE SET
        streak_count=CASE WHEN user_streak.last_date=($2::date-1) THEN user_streak.streak_count+1
          WHEN user_streak.last_date=$2::date THEN user_streak.streak_count ELSE 1 END,
        last_date=$2`,[CONFIG.user,today]);
  } catch(e){ console.warn('streak:',e.message); }

  // Add to local answerHistory for immediate display
  answerHistory.unshift({ exercise_id:exerciseId, is_correct:isCorrect, user_answer:String(userAnswer), answered_at:new Date().toISOString() });
  if(answerHistory.length>30) answerHistory.pop();
}

function nextExercise(){ SESSION.current++; renderExercise(); }
function endSession(){ showView('home'); renderHome(); }

function showSessionResults() {
  const elapsed=Math.round((Date.now()-SESSION.startTime)/1000);
  const mins=Math.floor(elapsed/60), secs=elapsed%60;
  const total=SESSION.correct+SESSION.wrong;
  const pct=total>0?Math.round(SESSION.correct/total*100):0;
  sql(`INSERT INTO session_history(user_id,category_id,score,total,duration_seconds,level) VALUES($1,$2,$3,$4,$5,$6)`,
    [CONFIG.user,SESSION.category,SESSION.correct,total,elapsed,currentLevel]).catch(()=>{});
  const scoreColor=pct>=70?'var(--success)':pct>=50?'var(--warn)':'var(--error)';
  const emoji=pct>=90?'üèÜ':pct>=70?'üéâ':pct>=50?'üí™':'üìö';
  document.getElementById('exercise-area').innerHTML=`
  <div class="session-results">
    <div style="font-size:1.4rem">${emoji}</div>
    <div class="session-score" style="color:${scoreColor}">${pct}<span>%</span></div>
    <div style="color:var(--text-muted);margin-bottom:1.5rem">${CATEGORIES[SESSION.category]?.name||SESSION.category}</div>
    <div class="session-breakdown">
      <div class="sb-item"><div class="sb-val" style="color:var(--success)">${SESSION.correct}</div><div class="sb-lbl">Poprawnych</div></div>
      <div class="sb-item"><div class="sb-val" style="color:var(--error)">${SESSION.wrong}</div><div class="sb-lbl">B≈Çƒôdnych</div></div>
      <div class="sb-item"><div class="sb-val" style="color:var(--accent2)">${mins}m ${secs}s</div><div class="sb-lbl">Czas</div></div>
    </div>
    <div class="action-row" style="justify-content:center;gap:1rem;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="startSession('${SESSION.category}')">üîÑ ƒÜwicz ponownie</button>
      <button class="btn btn-secondary" onclick="showView('history')">üìã Historia</button>
      <button class="btn btn-secondary" onclick="endSession()">‚Üê Kategorie</button>
    </div>
  </div>`;
}

// =====================================================
// HISTORIA ZADA≈É
// =====================================================
let historyFilter = 'all';

async function renderHistory() {
  const el=document.getElementById('history-list');
  el.innerHTML='<div style="color:var(--text-muted);text-align:center;padding:2rem">≈Åadowanie...</div>';
  try {
    const h = await sql(`SELECT ah.*, e.question, e.answer, e.explanation, e.category_id, e.type, e.text
      FROM answer_history ah
      LEFT JOIN exercises e ON e.id = ah.exercise_id
      WHERE ah.user_id=$1 ORDER BY ah.answered_at DESC LIMIT 30`,[CONFIG.user]);
    answerHistory = h;
    renderHistoryList();
  } catch(e) {
    // table might not exist yet
    el.innerHTML=`<div style="color:var(--text-muted);text-align:center;padding:2rem">
      Historia niedostƒôpna. Tabela answer_history mo≈ºe nie istnieƒá.<br>
      <small>Wykonaj zadanie ‚Äî historia zacznie siƒô zape≈Çniaƒá automatycznie.</small>
    </div>`;
  }
}

function filterHistory(f) {
  historyFilter=f;
  ['all','wrong','correct'].forEach(x=>{
    const btn=document.getElementById('hf-'+x);
    if(btn){ btn.style.borderColor=x===f?'var(--accent)':''; btn.style.color=x===f?'var(--accent)':''; }
  });
  renderHistoryList();
}

function renderHistoryList() {
  const el=document.getElementById('history-list');
  let items=answerHistory;
  if(historyFilter==='wrong')   items=items.filter(h=>!h.is_correct);
  if(historyFilter==='correct') items=items.filter(h=>h.is_correct);

  if(!items.length){
    el.innerHTML='<div style="color:var(--text-muted);text-align:center;padding:3rem">Brak wynik√≥w dla wybranego filtra.<br>Zacznij ƒáwiczyƒá!</div>';
    return;
  }

  el.innerHTML = items.map(h=>{
    const d=new Date(h.answered_at);
    const dateStr=d.toLocaleDateString('pl-PL')+' '+d.toLocaleTimeString('pl-PL',{hour:'2-digit',minute:'2-digit'});
    const catName=CATEGORIES[h.category_id]?.name||h.category_id||'‚Äî';
    const catIcon=CATEGORIES[h.category_id]?.icon||'‚Ä¢';
    const q=(h.question||'').replace(/\n/g,' ').substring(0,120)+(h.question?.length>120?'...':'');
    const resultColor=h.is_correct?'var(--success)':'var(--error)';
    const resultText=h.is_correct?'‚úÖ Poprawnie':'‚ùå B≈Çƒôdnie';
    const wrongInfo=!h.is_correct&&h.answer?`<div style="margin-top:.4rem;font-size:.82rem">
      Poprawna: <strong style="color:var(--success)">${h.answer}</strong>
      ${h.user_answer?` &nbsp;¬∑&nbsp; Twoja: <strong style="color:var(--error)">${h.user_answer}</strong>`:''}
    </div>`:'';

    return `<div class="history-item ${h.is_correct?'correct-item':'wrong-item'}">
      <div class="hi-top">
        <span class="hi-id">${h.exercise_id||'‚Äî'} ¬∑ ${catIcon} ${catName}</span>
        <span class="hi-result" style="color:${resultColor}">${resultText}</span>
      </div>
      <div class="hi-question">${q||'(brak pytania)'}</div>
      ${wrongInfo}
      ${h.explanation?`<details><summary>üìñ Wyja≈õnienie</summary><p>${h.explanation}</p></details>`:''}
      <div style="font-size:.72rem;color:var(--text-muted);margin-top:.4rem">${dateStr}</div>
    </div>`;
  }).join('');
}

// =====================================================
// STATS VIEW
// =====================================================
async function renderStats() {
  const el=document.getElementById('stats-content');
  el.innerHTML='<div style="color:var(--text-muted);text-align:center;padding:2rem">≈Åadowanie...</div>';
  try {
    const history=await sql('SELECT * FROM session_history WHERE user_id=$1 ORDER BY played_at DESC LIMIT 20',[CONFIG.user]);
    let html='<div style="font-family:\'Playfair Display\',serif;font-size:1.2rem;margin-bottom:1rem">Historia sesji</div>';
    if(!history.length){
      html+='<div style="color:var(--text-muted)">Brak historii. Zacznij ƒáwiczyƒá!</div>';
    } else {
      html+=`<table style="width:100%;border-collapse:collapse;font-size:.88rem">
        <thead><tr>${['Data','Kat.','Poziom','Wynik','%'].map(h=>
          `<th style="text-align:left;padding:.75rem 1rem;border-bottom:1px solid var(--border);color:var(--text-muted);font-family:'DM Mono',monospace;font-size:.75rem;text-transform:uppercase">${h}</th>`
        ).join('')}</tr></thead><tbody>`;
      history.forEach(h=>{
        const pct=h.total>0?Math.round(h.score/h.total*100):0;
        const cls=pct>=70?'var(--success)':pct>=50?'var(--warn)':'var(--error)';
        const lvlBadge=h.level==='rozszerzony'?'<span class="level-badge level-r">PR</span>':'<span class="level-badge level-p">PP</span>';
        html+=`<tr>
          <td style="padding:.75rem 1rem;border-bottom:1px solid rgba(42,45,58,.5)">${new Date(h.played_at).toLocaleDateString('pl-PL')}</td>
          <td style="padding:.75rem 1rem;border-bottom:1px solid rgba(42,45,58,.5)">${CATEGORIES[h.category_id]?.icon||''} ${CATEGORIES[h.category_id]?.name||h.category_id}</td>
          <td style="padding:.75rem 1rem;border-bottom:1px solid rgba(42,45,58,.5)">${lvlBadge}</td>
          <td style="padding:.75rem 1rem;border-bottom:1px solid rgba(42,45,58,.5)">${h.score}/${h.total}</td>
          <td style="padding:.75rem 1rem;border-bottom:1px solid rgba(42,45,58,.5);color:${cls};font-family:'DM Mono',monospace">${pct}%</td>
        </tr>`;
      });
      html+='</tbody></table>';
    }

    // Per-category bars
    html+='<div style="font-family:\'Playfair Display\',serif;font-size:1.2rem;margin:2rem 0 1rem">Wyniki wg kategorii</div>';
    Object.entries(CATEGORIES).forEach(([key,cat])=>{
      const catExs=exercises.filter(e=>e.category_id===key);
      const att=catExs.reduce((a,e)=>a+(progress[e.id]?.attempts||0),0);
      const corr=catExs.reduce((a,e)=>a+(progress[e.id]?.correct||0),0);
      const pct=att>0?Math.round(corr/att*100):0;
      html+=`<div style="display:flex;align-items:center;gap:1rem;margin-bottom:.75rem">
        <span style="min-width:180px;font-size:.85rem;color:var(--text-muted)">${cat.icon} ${cat.name}</span>
        <div style="flex:1;height:20px;background:var(--surface2);border-radius:6px;overflow:hidden">
          <div style="height:100%;width:${pct}%;background:${cat.color};border-radius:6px;transition:width .6s"></div>
        </div>
        <span style="font-family:'DM Mono',monospace;font-size:.82rem;min-width:40px;color:${pct>=70?'var(--success)':pct>=50?'var(--warn)':'var(--error)'}">${pct}%</span>
      </div>`;
    });
    el.innerHTML=html;
  } catch(e) {
    el.innerHTML=`<div style="color:var(--error)">B≈ÇƒÖd: ${e.message}</div>`;
  }
}

// =====================================================
// TEORIA
// =====================================================
const THEORY_TOPICS = [
  { id:'tenses', icon:'‚è∞', title:'Czasy angielskie', desc:'Wszystkie 12 czas√≥w z formami i przyk≈Çadami', color:'#4fc3f7' },
  { id:'conditionals', icon:'üîÄ', title:'Okresy warunkowe', desc:'0, 1, 2, 3 i mieszane + inwersja', color:'#f06292' },
  { id:'passive', icon:'üîÑ', title:'Strona bierna', desc:'Passive voice we wszystkich czasach', color:'#a5d6a7' },
  { id:'reported', icon:'üí¨', title:'Mowa zale≈ºna', desc:'Reported speech ‚Äî zasady i czasowniki', color:'#ffb74d' },
  { id:'modals', icon:'üéØ', title:'Modals ‚Äî czasowniki modalne', desc:'Must, should, could, may i perfect modals', color:'#ce93d8' },
  { id:'word_formation', icon:'üèóÔ∏è', title:'S≈Çowotw√≥rstwo', desc:'Prefiksy, sufiksy, tworzenie wyraz√≥w', color:'#80cbc4' },
  { id:'collocations', icon:'üîó', title:'Kolokacje i idiomy', desc:'Make/do/take/have + typowe wyra≈ºenia', color:'#ffcc80' },
  { id:'linking', icon:'üßµ', title:'Sp√≥jniki i ≈ÇƒÖczniki', desc:'Contrast, cause, result, addition...', color:'#ef9a9a' },
  { id:'essay_writing', icon:'‚úçÔ∏è', title:'Pisanie esej√≥w', desc:'Struktura, zwroty, argumentacja', color:'#b39ddb' },
  { id:'email_writing', icon:'üìß', title:'Pisanie e-maili', desc:'Formalny i nieformalny ‚Äî szablony', color:'#80deea' },
  { id:'reading_hacks', icon:'üìñ', title:'Hacki do czytania', desc:'Strategia T/F/NG i multiple choice', color:'#e6ee9c' },
  { id:'exam_tips', icon:'üèÜ', title:'Taktyka na egzaminie', desc:'Jak nie straciƒá punkt√≥w ‚Äî checklist', color:'#ffab91' },
];

const THEORY_CONTENT = {
  tenses: `
<h2>‚è∞ Czasy angielskie ‚Äî Kompletny Przewodnik</h2>
<div class="hack">Na maturze najczƒô≈õciej testowane: Present Perfect vs Past Simple, Past Perfect w 3rd conditional, Present Perfect Continuous vs Present Perfect Simple</div>

<h3>PRESENT SIMPLE</h3>
<p>U≈ºycie: czynno≈õci regularne, prawdy og√≥lne, rozk≈Çady. Tworzone: V (+ s/es dla he/she/it).</p>
<div class="example">I work every day. / She works in a hospital. / Water boils at 100¬∞C.</div>

<h3>PRESENT CONTINUOUS</h3>
<p>U≈ºycie: czynno≈õci teraz, plany na przysz≈Ço≈õƒá, czynno≈õci tymczasowe.</p>
<div class="example">I am studying right now. / We are meeting tomorrow. / She is always complaining! (irytacja)</div>
<div class="hack">Stative verbs NIE u≈ºywajƒÖ continuous: know, believe, understand, want, love, have (posiadanie), see, smell, taste</div>

<h3>PRESENT PERFECT SIMPLE</h3>
<p>U≈ºycie: czynno≈õci z efektem teraz, do≈õwiadczenia, niedawne zdarzenia. Signal words: already, yet, just, ever, never, recently, so far.</p>
<div class="example">I have just finished. / Have you ever been to Paris? / She hasn't called yet.</div>

<h3>PRESENT PERFECT CONTINUOUS</h3>
<p>U≈ºycie: czynno≈õƒá trwa≈Ça do teraz (nacisk na czas trwania). Signal: for, since, how long.</p>
<div class="example">I have been waiting for 2 hours. / She has been working here since 2020.</div>
<div class="hack">PPS = wynik wa≈ºny (I have painted the wall ‚Äî ≈õciana jest pomalowana) | PPC = czas trwania wa≈ºny (I have been painting ‚Äî jestem zmƒôczony)</div>

<h3>PAST SIMPLE</h3>
<p>U≈ºycie: zako≈Ñczone czynno≈õci w przesz≈Ço≈õci, czas okre≈õlony. V2 (ed dla regularnych).</p>
<div class="example">She left yesterday. / We met in 2019. / I didn't sleep well.</div>

<h3>PAST CONTINUOUS</h3>
<p>U≈ºycie: czynno≈õƒá w toku w pewnym momencie przesz≈Ço≈õci, t≈Ço dla innej czynno≈õci.</p>
<div class="example">While I was sleeping, she called. / At 8pm we were having dinner.</div>

<h3>PAST PERFECT SIMPLE</h3>
<p>U≈ºycie: czynno≈õƒá wcze≈õniejsza od innej czynno≈õci w przesz≈Ço≈õci (3rd conditional!).</p>
<div class="example">By the time I arrived, she had already left. / If I had studied, I would have passed.</div>

<h3>FUTURE ‚Äî WILL vs GOING TO vs PRESENT CONTINUOUS</h3>
<table><tr><th>Czas</th><th>U≈ºycie</th><th>Przyk≈Çad</th></tr>
<tr><td>will</td><td>decyzja w tej chwili, obietnica, przepowiednia</td><td>I'll help you. It will rain.</td></tr>
<tr><td>going to</td><td>plan wcze≈õniej podjƒôty, co≈õ widoczne ≈ºe nastƒÖpi</td><td>I'm going to study medicine. Look ‚Äî it's going to fall!</td></tr>
<tr><td>Present Continuous</td><td>aran≈ºacja z innymi, plan z datƒÖ/godzinƒÖ</td><td>I'm meeting Tom at 6pm tomorrow.</td></tr>
</table>

<h3>FUTURE PERFECT & FUTURE CONTINUOUS</h3>
<div class="example">By next year I will have graduated. (FP ‚Äî zako≈Ñczone przed momentem)
I will be working at 9pm. (FC ‚Äî w toku o danej godzinie)</div>`,

  conditionals: `
<h2>üîÄ Okresy Warunkowe ‚Äî Zero do Mistrzowskiego</h2>
<div class="hack">Najczƒô≈õciej na maturze: 3rd conditional (≈ºal za przesz≈Ço≈õciƒÖ) i inwersja (Had I known..., Were it...)</div>

<h3>0 CONDITIONAL ‚Äî og√≥lne prawdy</h3>
<div class="example">If + Present Simple ‚Üí Present Simple
If you heat water to 100¬∞C, it boils. / If it rains, the ground gets wet.</div>

<h3>1ST CONDITIONAL ‚Äî realna mo≈ºliwo≈õƒá</h3>
<div class="example">If + Present Simple ‚Üí will + V
If I study hard, I will pass. / If she calls, I'll tell her.</div>

<h3>2ND CONDITIONAL ‚Äî nierealna/ma≈Ço prawdopodobna</h3>
<div class="example">If + Past Simple ‚Üí would + V
If I were rich, I would travel the world. / If she had a car, she would drive to work.</div>
<div class="hack">Po "if" zawsze "were" (nie was) ‚Äî nawet dla I/he/she: "If I WERE you..."</div>

<h3>3RD CONDITIONAL ‚Äî niemo≈ºliwa (przesz≈Ço≈õƒá)</h3>
<div class="example">If + Past Perfect ‚Üí would have + Past Participle
If I had studied, I would have passed. / If she hadn't left, we would have met.</div>

<h3>MIESZANE (Mixed Conditional)</h3>
<div class="example">If I had studied medicine (past), I would be a doctor now (present).
Przesz≈Ço≈õƒá ‚Üí efekt teraz</div>

<h3>INWERSJA ‚Äî bez "if"</h3>
<table><tr><th>Zwyk≈Çe</th><th>Inwersja</th></tr>
<tr><td>If I had known</td><td>Had I known</td></tr>
<tr><td>If I were you</td><td>Were I you</td></tr>
<tr><td>If it should happen</td><td>Should it happen</td></tr>
</table>
<div class="hack">Inwersja = warunkowe + bardziej formalne/literackie. Na maturze: "Had I known he was ill, I would have visited him."</div>

<h3>UNLESS, PROVIDED THAT, AS LONG AS</h3>
<div class="example">Unless = if...not: Unless you leave now, you'll miss the train.
Provided/As long as = pod warunkiem ≈ºe: I'll help you provided you keep it secret.</div>`,

  passive: `
<h2>üîÑ Strona Bierna ‚Äî Passive Voice</h2>
<div class="hack">Tworzenie: odpowiednia forma BE + Past Participle. Podmiot zdania czynnego = "by + agent" (opcjonalnie)</div>

<h3>TABELA WSZYSTKICH CZAS√ìW</h3>
<table><tr><th>Czas</th><th>Aktywna</th><th>Bierna</th></tr>
<tr><td>Pres. Simple</td><td>They build it</td><td>It is built</td></tr>
<tr><td>Pres. Continuous</td><td>They are building it</td><td>It is being built</td></tr>
<tr><td>Pres. Perfect</td><td>They have built it</td><td>It has been built</td></tr>
<tr><td>Past Simple</td><td>They built it</td><td>It was built</td></tr>
<tr><td>Past Continuous</td><td>They were building it</td><td>It was being built</td></tr>
<tr><td>Past Perfect</td><td>They had built it</td><td>It had been built</td></tr>
<tr><td>Future Simple</td><td>They will build it</td><td>It will be built</td></tr>
<tr><td>Modal</td><td>They must build it</td><td>It must be built</td></tr>
<tr><td>Modal Perfect</td><td>They must have built it</td><td>It must have been built</td></tr>
</table>

<h3>PASYWNE KONSTRUKCJE REPORTINGOWE</h3>
<p>Bardzo czƒôsto na maturze! Schemat: It is said that... ‚Üí He is said to V...</p>
<div class="example">People believe that he stole the money.
‚Üí It is believed that he stole the money.
‚Üí He is believed to have stolen the money.

People say he is a genius.
‚Üí He is said to be a genius.</div>
<div class="hack">Czasowniki: say, believe, think, report, claim, know, expect, suppose, allege + to be / to have done</div>

<h3>PHRASAL VERBS W STRONIE BIERNEJ</h3>
<div class="example">Someone broke into the office. ‚Üí The office was broken into.
They looked after the children. ‚Üí The children were looked after.</div>
<div class="hack">Phrasal verb traktuj jako ca≈Ço≈õƒá ‚Äî nie rozdzielaj!</div>`,

  reported: `
<h2>üí¨ Mowa Zale≈ºna ‚Äî Reported Speech</h2>
<div class="hack">Kluczowe: backshift czas√≥w + zmiana zaimk√≥w + zmiana wyra≈ºe≈Ñ czasu</div>

<h3>BACKSHIFT CZAS√ìW</h3>
<table><tr><th>Mowa niezale≈ºna</th><th>Mowa zale≈ºna</th></tr>
<tr><td>Present Simple</td><td>Past Simple</td></tr>
<tr><td>Present Continuous</td><td>Past Continuous</td></tr>
<tr><td>Present Perfect</td><td>Past Perfect</td></tr>
<tr><td>Past Simple</td><td>Past Perfect</td></tr>
<tr><td>will</td><td>would</td></tr>
<tr><td>can</td><td>could</td></tr>
<tr><td>may</td><td>might</td></tr>
<tr><td>must</td><td>had to / must (nakaz zewnƒôtrzny)</td></tr>
</table>

<h3>CZASOWNIKI REPORTING + WZORZEC</h3>
<table><tr><th>Wzorzec</th><th>Czasowniki</th></tr>
<tr><td>+ to-inf</td><td>agree, offer, refuse, promise, threaten, decide</td></tr>
<tr><td>sb + to-inf</td><td>tell, ask, warn, advise, invite, order, encourage, remind</td></tr>
<tr><td>+ gerund / that</td><td>admit, deny, suggest, recommend</td></tr>
<tr><td>sb + that</td><td>inform, remind, warn, promise, assure</td></tr>
</table>
<div class="example">"Don't touch anything!" ‚Üí The professor warned us not to touch anything.
"Why don't you take a break?" ‚Üí His colleague suggested (that) he take/should take a break.
"I didn't do it." ‚Üí She denied doing it / denied that she had done it.</div>

<h3>ZMIANY WYRA≈ªE≈É CZASU</h3>
<div class="example">now ‚Üí then | today ‚Üí that day | yesterday ‚Üí the day before
tomorrow ‚Üí the next day | last week ‚Üí the week before | here ‚Üí there</div>`,

  modals: `
<h2>üéØ Czasowniki Modalne</h2>
<div class="hack">Modal perfect (modal + have + PP) = ocena, dedukcja lub ≈ºal dotyczƒÖcy PRZESZ≈ÅO≈öCI</div>

<h3>PRESENT / FUTURE MODALS</h3>
<table><tr><th>Modal</th><th>Znaczenie</th><th>Przyk≈Çad</th></tr>
<tr><td>must</td><td>obowiƒÖzek, dedukcja (+)</td><td>You must study. / He must be tired.</td></tr>
<tr><td>mustn't</td><td>zakaz</td><td>You mustn't smoke here.</td></tr>
<tr><td>don't have to</td><td>brak obowiƒÖzku</td><td>You don't have to come.</td></tr>
<tr><td>should/ought to</td><td>rada, powinno≈õƒá</td><td>You should see a doctor.</td></tr>
<tr><td>can/could</td><td>umiejƒôtno≈õƒá, mo≈ºliwo≈õƒá, pro≈õba</td><td>Can you help? / Could you...? (grzeczniej)</td></tr>
<tr><td>may/might</td><td>mo≈ºliwo≈õƒá (may=50%, might=30%)</td><td>It may rain. / She might be late.</td></tr>
<tr><td>would rather</td><td>wolenie</td><td>I'd rather stay home.</td></tr>
<tr><td>had better</td><td>rada z ostrze≈ºeniem</td><td>You'd better leave now.</td></tr>
</table>

<h3>MODAL PERFECT ‚Äî o PRZESZ≈ÅO≈öCI</h3>
<table><tr><th>Modal</th><th>Znaczenie</th><th>Przyk≈Çad</th></tr>
<tr><td>must have done</td><td>pewna dedukcja (+)</td><td>He must have left already.</td></tr>
<tr><td>can't have done</td><td>pewna dedukcja (-)</td><td>She can't have said that.</td></tr>
<tr><td>may/might have done</td><td>mo≈ºliwo≈õƒá</td><td>They may have missed the bus.</td></tr>
<tr><td>should have done</td><td>krytyka ‚Äî powiniene≈õ by≈Ç</td><td>You should have called me.</td></tr>
<tr><td>shouldn't have done</td><td>krytyka ‚Äî nie powiniene≈õ by≈Ç</td><td>He shouldn't have said that.</td></tr>
<tr><td>needn't have done</td><td>niepotrzebne dzia≈Çanie</td><td>You needn't have bought flowers.</td></tr>
<tr><td>could have done</td><td>mo≈ºliwo≈õƒá nierealizowana</td><td>She could have won if she had tried.</td></tr>
</table>`,

  word_formation: `
<h2>üèóÔ∏è S≈Çowotw√≥rstwo ‚Äî Word Formation</h2>
<div class="hack">Naucz siƒô grup sufiks√≥w na pamiƒôƒá. Na maturze ZAWSZE jest Word Formation ‚Äî przewa≈ºnie 4 wyrazy pochodne.</div>

<h3>SUFIKSY ‚Äî RZECZOWNIKI</h3>
<div class="example">-tion/-sion: information, decision, education, pollution
-ment: government, employment, achievement, improvement
-ness: happiness, weakness, awareness, consciousness
-ity: ability, possibility, creativity, equality
-ance/-ence: importance, intelligence, difference, performance
-er/-or: teacher, actor, visitor, employer
-ist: scientist, journalist, pianist
-ism: capitalism, racism, criticism
-ship: friendship, leadership, relationship</div>

<h3>SUFIKSY ‚Äî PRZYMIOTNIKI</h3>
<div class="example">-ful: beautiful, careful, helpful, successful
-less: careless, useless, homeless, hopeless
-ous/-ious: dangerous, famous, mysterious, ambitious
-al/-ial: national, financial, industrial
-ic: scientific, historic, economic
-ive: creative, attractive, competitive
-able/-ible: comfortable, responsible, reliable
-ing/-ed: interesting/interested, boring/bored (czynny/bierny!)</div>

<h3>PREFIKSY</h3>
<table><tr><th>Prefiks</th><th>Znaczenie</th><th>Przyk≈Çady</th></tr>
<tr><td>un-</td><td>nie-</td><td>unhappy, unusual, unexpected, unconvinced</td></tr>
<tr><td>in-/im-/ir-/il-</td><td>nie-</td><td>incorrect, impossible, irregular, illegal</td></tr>
<tr><td>dis-</td><td>przeciwie≈Ñstwo</td><td>disagree, dishonest, disappear</td></tr>
<tr><td>mis-</td><td>≈∫le</td><td>misunderstand, mislead, misuse</td></tr>
<tr><td>over-</td><td>za du≈ºo</td><td>overweight, overlook, overestimate</td></tr>
<tr><td>under-</td><td>za ma≈Ço</td><td>underestimate, underpaid, undermine</td></tr>
<tr><td>re-</td><td>ponownie</td><td>rewrite, rebuild, reconsider</td></tr>
<tr><td>pre-</td><td>przed</td><td>preview, prehistoric, preoccupied</td></tr>
</table>

<h3>SUFIKSY ‚Äî PRZYS≈Å√ìWKI I CZASOWNIKI</h3>
<div class="example">Przys≈Ç√≥wki: adjective + -ly: quickly, carefully, surprisingly
Czasowniki: -ify: simplify, clarify, modify | -ize/-ise: organize, realize, emphasize
-en: widen, strengthen, deepen, sharpen</div>`,

  collocations: `
<h2>üîó Kolokacje i Wyra≈ºenia Sta≈Çe</h2>
<div class="hack">Make/do/take/have ‚Äî najczƒôstsze pomy≈Çki na maturze. Ucz siƒô ca≈Çych wyra≈ºe≈Ñ, nie pojedynczych s≈Ç√≥w!</div>

<h3>MAKE vs DO</h3>
<table><tr><th>MAKE (tworzyƒá, produkowaƒá)</th><th>DO (czynno≈õƒá, praca)</th></tr>
<tr><td>make a decision / mistake / effort</td><td>do homework / research / damage</td></tr>
<tr><td>make progress / an impression</td><td>do your best / a favour</td></tr>
<tr><td>make a complaint / suggestion</td><td>do business / an exercise</td></tr>
<tr><td>make friends / money / a profit</td><td>do the dishes / shopping / cleaning</td></tr>
<tr><td>make up your mind</td><td>do well / badly / without</td></tr>
</table>

<h3>TAKE</h3>
<div class="example">take a risk / chance / break / photo / exam / responsibility
take part in / place / advantage of / care of
take sb by surprise / into account / for granted</div>

<h3>HAVE</h3>
<div class="example">have a look / rest / shower / argument / conversation
have an impact / influence / effect on
have difficulty doing sth / trouble doing sth</div>

<h3>PHRASAL VERBS ‚Äî NAJWA≈ªNIEJSZE</h3>
<table><tr><th>Phrasal verb</th><th>Znaczenie</th></tr>
<tr><td>bring up</td><td>wychowaƒá / poruszyƒá temat</td></tr>
<tr><td>call off</td><td>odwo≈Çaƒá</td></tr>
<tr><td>come across</td><td>natknƒÖƒá siƒô na</td></tr>
<tr><td>give up</td><td>poddaƒá siƒô / rzuciƒá</td></tr>
<tr><td>look into</td><td>zbadaƒá, dochodziƒá</td></tr>
<tr><td>make up</td><td>wymy≈õliƒá / pogodziƒá siƒô</td></tr>
<tr><td>put off</td><td>od≈Ço≈ºyƒá na p√≥≈∫niej</td></tr>
<tr><td>set up</td><td>za≈Ço≈ºyƒá (firmƒô)</td></tr>
<tr><td>take over</td><td>przejƒÖƒá kontrolƒô</td></tr>
<tr><td>turn down</td><td>odrzuciƒá (propozycjƒô)</td></tr>
<tr><td>usher in</td><td>zapoczƒÖtkowaƒá</td></tr>
<tr><td>spark off</td><td>wywo≈Çaƒá, zainicjowaƒá</td></tr>
</table>`,

  linking: `
<h2>üßµ Sp√≥jniki i Wyra≈ºenia ≈ÅƒÖczƒÖce</h2>
<div class="hack">R√≥≈ºnorodno≈õƒá sp√≥jnik√≥w = wy≈ºszy wynik za writing. Nie u≈ºywaj ciƒÖgle "because" i "but"!</div>

<h3>CONTRAST (kontrast)</h3>
<div class="example">but, however, nevertheless, nonetheless, yet, still
Although / Even though + clause: Although she was tired, she continued.
Despite / In spite of + noun/gerund: Despite being tired, she continued.
while, whereas: While cities grew, rural areas declined.</div>

<h3>CAUSE & REASON (przyczyna)</h3>
<div class="example">because, since, as, due to, owing to, because of
as a result of, on account of, given that</div>

<h3>RESULT & CONSEQUENCE (skutek)</h3>
<div class="example">so, therefore, consequently, as a result, hence, thus
so...that, such...that: It was so cold that we couldn't go out.</div>

<h3>ADDITION (dodanie)</h3>
<div class="example">furthermore, moreover, in addition, besides, what is more
not only...but also, as well as, both...and</div>

<h3>EXEMPLIFICATION (przyk≈Çady)</h3>
<div class="example">for example, for instance, such as, namely, including</div>

<h3>CONCESSION (ustƒôpstwo)</h3>
<div class="example">admittedly, granted, it is true that...however
even if, even though, regardless of</div>

<h3>CONDITION</h3>
<div class="example">if, unless, provided that, as long as, on condition that
given that, in case, suppose/supposing</div>`,

  essay_writing: `
<h2>‚úçÔ∏è Pisanie Esej√≥w ‚Äî Strategia i Zwroty</h2>
<div class="hack">Struktura: WSTƒòP (teza) ‚Üí ARGUMENT ZA ‚Üí ARGUMENT PRZECIW ‚Üí KONTRARGUMENT ‚Üí ZAKO≈ÉCZENIE (opinia)</div>

<h3>STRUKTURA ESEJU (200‚Äì250 s≈Ç√≥w)</h3>
<div class="example">¬ß1 WSTƒòP (2-3 zdania): Wprowad≈∫ temat, sformu≈Çuj tezƒô
¬ß2 ARGUMENT ZA (4-5 zda≈Ñ): g≈Ç√≥wny argument + rozwiniƒôcie + przyk≈Çad
¬ß3 ARGUMENT PRZECIW (4-5 zda≈Ñ): kontrargument + rozwiniƒôcie
¬ß4 ZAKO≈ÉCZENIE (2-3 zdania): podsumowanie + w≈Çasna opinia</div>

<h3>ZWROTY ‚Äî WSTƒòP</h3>
<div class="example">The question of whether... has long been debated.
In recent years, the issue of... has gained increasing attention.
It is widely believed that... / Many people argue that...
This essay will examine both sides of the argument regarding...</div>

<h3>ZWROTY ‚Äî ARGUMENTY</h3>
<div class="example">First and foremost, / To begin with, / One of the main arguments in favour...
Furthermore, / Moreover, / In addition to this, / What is more,
On the other hand, / However, / Conversely, / By contrast,
It could be argued that... / Critics of this view point out that...</div>

<h3>ZWROTY ‚Äî W≈ÅASNA OPINIA</h3>
<div class="example">In my view, / In my opinion, / From my perspective,
I firmly believe that... / I am convinced that...
Taking everything into consideration, / All things considered,
On balance, I would argue that...</div>

<h3>ZAKO≈ÉCZENIE</h3>
<div class="example">To sum up, / In conclusion, / To conclude,
Having considered both sides, I believe...
While there are valid arguments on both sides, ultimately...</div>

<h3>S≈ÅOWNICTWO DO ESEJ√ìW (unikaj powt√≥rze≈Ñ)</h3>
<table><tr><th>Zamiast</th><th>U≈ºyj</th></tr>
<tr><td>good</td><td>beneficial, advantageous, positive, favourable</td></tr>
<tr><td>bad</td><td>detrimental, harmful, negative, adverse</td></tr>
<tr><td>big</td><td>significant, substantial, considerable, major</td></tr>
<tr><td>show</td><td>demonstrate, reveal, indicate, highlight</td></tr>
<tr><td>help</td><td>facilitate, enable, assist, support</td></tr>
<tr><td>think</td><td>argue, contend, maintain, assert, claim</td></tr>
</table>`,

  email_writing: `
<h2>üìß Pisanie E-maili ‚Äî Szablony</h2>
<div class="hack">Najczƒôstszy b≈ÇƒÖd: mieszanie stylu formalnego z nieformalnym. Decyduj na poczƒÖtku i trzymaj siƒô konsekwentnie!</div>

<h3>E-MAIL FORMALNY</h3>
<div class="example">NAG≈Å√ìWEK:
Dear Mr/Ms [Nazwisko],
Dear Sir or Madam, (gdy nie znamy nazwiska)
Dear Hiring Manager, (aplikacja o pracƒô)

OTWARCIE:
I am writing to... (apply for / enquire about / express my concern regarding / complain about)
I am contacting you in connection with...
With reference to your advertisement / your email of [date]...

ZAKO≈ÉCZENIE:
I look forward to hearing from you.
I would be grateful if you could...
Please do not hesitate to contact me should you require any further information.

FORMU≈ÅA KO≈ÉCOWA:
Yours sincerely, [gdy znamy nazwisko]
Yours faithfully, [gdy pisali≈õmy Dear Sir/Madam]</div>

<h3>E-MAIL NIEFORMALNY</h3>
<div class="example">NAG≈Å√ìWEK:
Hi [Imiƒô]! / Hey [Imiƒô], / Dear [Imiƒô],

OTWARCIE:
Thanks so much for your email! / Great to hear from you!
How are things? / I hope you're doing well!
I'm writing because... / I just wanted to let you know that...

PYTANIA (3 punkty zadania = 3 pytania!):
I was wondering if... / Could you let me know...?
What would you recommend...? / Do you think...?

ZAKO≈ÉCZENIE:
Can't wait to hear from you! / Drop me a line soon!
Let me know what you think! / Hope to hear from you soon!
Take care, / Best wishes, / Lots of love,</div>

<h3>APLIKACJA O PRACƒò</h3>
<div class="example">I am writing to apply for the position of [stanowisko] as advertised in [≈∫r√≥d≈Ço].
I have [X years of] experience in... / I am currently studying...
I am particularly interested in this role because...
I am a motivated / dedicated / enthusiastic [przymiotnik] individual who...
I am available for interview at your earliest convenience.
I have attached my CV for your consideration.</div>`,

  reading_hacks: `
<h2>üìñ Hacki do Zada≈Ñ Czytania</h2>
<div class="hack">Przeczytaj PYTANIA zanim przeczytasz tekst. Zakre≈õl kluczowe s≈Çowa w pytaniach!</div>

<h3>TRUE / FALSE / NOT GIVEN ‚Äî STRATEGIA</h3>
<div class="example">TRUE   = informacja JEST w tek≈õcie i potwierdza zdanie
FALSE  = informacja JEST w tek≈õcie i ZAPRZECZA zdaniu
NOT GIVEN = informacja NIE POJAWIA SIƒò w tek≈õcie</div>
<div class="hack">NOT GIVEN ‚â† False! Nie wnioskuj, nie domy≈õlaj siƒô. Je≈õli tekst nie wspomina ‚Üí NOT GIVEN</div>

<p><strong>Pu≈Çapki NG:</strong></p>
<ul>
<li>Zdanie u≈ºywa logiki zdroworozsƒÖdkowej, ale tekst tego nie stwierdza</li>
<li>Zdanie m√≥wi o czym≈õ powiƒÖzanym, ale nie to≈ºsamym z tekstem</li>
<li>Tekst m√≥wi A, zdanie m√≥wi B (kt√≥re logicznie wynika≈Çoby z A, ale nie jest powiedziane)</li>
</ul>

<h3>MULTIPLE CHOICE ‚Äî STRATEGIA</h3>
<ul>
<li>Znajd≈∫ fragment w tek≈õcie odpowiadajƒÖcy ka≈ºdemu pytaniu</li>
<li>Wyeliminuj 2 b≈Çƒôdne odpowiedzi (za mocne stwierdzenia, fakty niezgodne)</li>
<li>Parafrazuj ‚Äî poprawna odpowied≈∫ to zazwyczaj parafraz tekstu, nie dos≈Çowny cytat</li>
<li>Uwa≈ºaj na DISTRAKTORY: s≈Çowa z tekstu, kt√≥re brzmiƒÖ dobrze, ale sƒÖ w z≈Çym kontek≈õcie</li>
</ul>

<h3>TYPOWE PU≈ÅAPKI W OPCJACH</h3>
<div class="example">‚ùå "always", "never", "all", "only" ‚Äî zazwyczaj b≈Çƒôdne (za mocne)
‚ùå Opcja brana z zupe≈Çnie innej czƒô≈õci tekstu
‚ùå Opcja zawiera s≈Çowa z tekstu, ale zmienia sens
‚úÖ Synonim lub parafraza zdania z tekstu = zazwyczaj poprawna</div>`,

  exam_tips: `
<h2>üèÜ Taktyka na Egzaminie ‚Äî Checklist</h2>

<h3>PRZED EGZAMINEM</h3>
<ul>
<li>‚úÖ Przejrzyj najczƒôstsze struktury gramatyczne (transformacje)</li>
<li>‚úÖ Naucz siƒô szablon√≥w email formalny/nieformalny + essay</li>
<li>‚úÖ Powt√≥rz prefiksy/sufiksy i kolokacje</li>
<li>‚úÖ Przeƒáwicz T/F/NG na tekstach ‚Äî strategia czytania</li>
</ul>

<h3>PODCZAS EGZAMINU ‚Äî ROZUMIENIE TEKST√ìW</h3>
<ul>
<li>Przeczytaj pytania PRZED tekstem ‚Äî zakre≈õl kluczowe s≈Çowa</li>
<li>Pierwsze czytanie szybkie ‚Äî og√≥lne zrozumienie</li>
<li>Drugie czytanie ‚Äî szukaj fragment√≥w odpowiadajƒÖcych pytaniom</li>
<li>T/F/NG: nie zgaduj, znajd≈∫ DOW√ìD w tek≈õcie</li>
</ul>

<h3>TRANSFORMACJE ZDA≈É ‚Äî HACKS</h3>
<div class="example">so...that ‚Üí too...to / such...that
although + clause ‚Üí despite + gerund
it's the first time ‚Üí Present Perfect
last time + Past Simple ‚Üí Present Perfect + since/for
active ‚Üí passive (zwr√≥ƒá uwagƒô na czas)
wish/if only + Past Perfect ‚Üí ≈ºal za przesz≈Ço≈õciƒÖ</div>

<h3>PISANIE ‚Äî CHECKLIST PRZED ODDANIEM</h3>
<ul>
<li>‚úÖ Czy napisa≈Çem odpowiedniƒÖ liczbƒô s≈Ç√≥w? (esej 200‚Äì250, email 150‚Äì200)</li>
<li>‚úÖ Czy mam wstƒôp, rozwiniƒôcie i zako≈Ñczenie?</li>
<li>‚úÖ Czy u≈ºy≈Çem r√≥≈ºnorodnych czas√≥w i struktur?</li>
<li>‚úÖ Czy u≈ºy≈Çem sp√≥jnik√≥w (however, moreover, despite)?</li>
<li>‚úÖ Czy nie powtarzam tych samych s≈Ç√≥w?</li>
<li>‚úÖ Czy email ma odpowiedni nag≈Ç√≥wek i formu≈Çƒô ko≈ÑcowƒÖ?</li>
</ul>

<h3>PUNKTACJA ‚Äî CO OCENIAJƒÑ EGZAMINATORZY</h3>
<table><tr><th>Kryterium</th><th>Opis</th></tr>
<tr><td>Tre≈õƒá</td><td>Czy odpowied≈∫ na temat? Wszystkie punkty z polecenia?</td></tr>
<tr><td>Sp√≥jno≈õƒá</td><td>Logika, ≈ÇƒÖczniki, akapity</td></tr>
<tr><td>Zakres jƒôzykowy</td><td>Bogactwo s≈Çownictwa, r√≥≈ºnorodno≈õƒá struktur</td></tr>
<tr><td>Poprawno≈õƒá</td><td>Gramatyka, interpunkcja, ortografia</td></tr>
</table>

<h3>NAJCZƒòSTSZE B≈ÅƒòDY NA MATURZE</h3>
<div class="example">‚ùå Mieszanie styli (formalny + nieformalny w jednym emailu)
‚ùå Za kr√≥tkie odpowiedzi (poni≈ºej minimum s≈Ç√≥w)
‚ùå Powtarzanie "very", "good", "bad", "because"
‚ùå Nie odpowiadanie na wszystkie punkty w poleceniu
‚ùå Brak akapit√≥w w wypowiedzi pisemnej</div>`
};

function renderTheoryGrid() {
  const grid = document.getElementById('theory-grid');
  grid.innerHTML = THEORY_TOPICS.map(t=>`
    <div class="theory-card" style="--cat-color:${t.color}" onclick="openTheory('${t.id}')">
      <div class="t-icon">${t.icon}</div>
      <div class="t-title">${t.title}</div>
      <div class="t-desc">${t.desc}</div>
    </div>`).join('');
}

function openTheory(id) {
  const content = THEORY_CONTENT[id];
  if(!content) return;
  document.getElementById('theory-grid-wrap').style.display='none';
  const wrap=document.getElementById('theory-article-wrap');
  wrap.style.display='block';
  document.getElementById('theory-article').innerHTML=content;
}

function closeTheory() {
  document.getElementById('theory-grid-wrap').style.display='block';
  document.getElementById('theory-article-wrap').style.display='none';
}

// =====================================================
// IMPORT JSON
// =====================================================
let importData=[];

function toggleJSONPaste(){
  const t=document.getElementById('json-paste');
  t.style.display=t.style.display==='none'?'block':'none';
}

function loadJSONFile(event){
  const file=event.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=(e)=>{ try{ importData=JSON.parse(e.target.result); if(!Array.isArray(importData)) importData=[importData]; renderImportPreview(); }catch(err){ alert('B≈ÇƒÖd JSON: '+err.message); } };
  reader.readAsText(file);
}

function parseJSONPaste(){
  const val=document.getElementById('json-paste').value.trim(); if(!val) return;
  try{ importData=JSON.parse(val); if(!Array.isArray(importData)) importData=[importData]; renderImportPreview(); }catch(e){}
}

function clearImport(){
  importData=[];
  document.getElementById('import-preview').style.display='none';
  document.getElementById('import-action').style.display='none';
  document.getElementById('push-log').innerHTML='';
  document.getElementById('json-paste').value='';
  document.getElementById('json-file-input').value='';
}

async function renderImportPreview(){
  const preview=document.getElementById('import-preview'), action=document.getElementById('import-action');
  if(!importData.length){ preview.style.display='none'; action.style.display='none'; return; }
  let existingIds=new Set();
  try{ const rows=await sql('SELECT id FROM exercises'); rows.forEach(r=>existingIds.add(r.id)); }catch(e){}
  const newItems=importData.filter(e=>!existingIds.has(e.id));
  const catCounts={};
  importData.forEach(e=>{ const cat=e.category||'?'; catCounts[cat]=(catCounts[cat]||0)+1; });
  document.getElementById('import-summary').textContent=
    '≈ÅƒÖcznie: '+importData.length+' zada≈Ñ\nNowe: '+newItems.length+'  Duplikaty: '+(importData.length-newItems.length)+
    '\n\nKategorie:\n'+Object.entries(catCounts).map(([k,v])=>'  '+(CATEGORIES[k]?.icon||'‚Ä¢')+' '+k+': '+v).join('\n');
  let tbl='<table style="width:100%;border-collapse:collapse;font-size:.78rem"><thead><tr>'+
    ['ID','Kategoria','Typ','Rok','Poziom','Status'].map(h=>'<th style="text-align:left;padding:.4rem .75rem;border-bottom:1px solid var(--border);color:var(--text-muted)">'+h+'</th>').join('')+
    '</tr></thead><tbody>';
  importData.slice(0,60).forEach(e=>{
    const isDup=existingIds.has(e.id);
    tbl+='<tr style="opacity:'+(isDup?.6:1)+'">'+
      '<td style="padding:.35rem .75rem;border-bottom:1px solid rgba(42,45,58,.4);font-family:\'DM Mono\',monospace;color:var(--accent2)">'+e.id+'</td>'+
      '<td style="padding:.35rem .75rem;border-bottom:1px solid rgba(42,45,58,.4)">'+(e.category||'‚Äî')+'</td>'+
      '<td style="padding:.35rem .75rem;border-bottom:1px solid rgba(42,45,58,.4);color:var(--text-muted)">'+(e.type||'‚Äî')+'</td>'+
      '<td style="padding:.35rem .75rem;border-bottom:1px solid rgba(42,45,58,.4);color:var(--text-muted)">'+(e.year||'‚Äî')+'</td>'+
      '<td style="padding:.35rem .75rem;border-bottom:1px solid rgba(42,45,58,.4)">'+(e.level||'rozszerzony')+'</td>'+
      '<td style="padding:.35rem .75rem;border-bottom:1px solid rgba(42,45,58,.4);color:'+(isDup?'var(--warn)':'var(--success)')+'">'+( isDup?'duplikat':'nowe')+'</td>'+
      '</tr>';
  });
  if(importData.length>60) tbl+='<tr><td colspan="6" style="padding:.5rem .75rem;color:var(--text-muted)">...i '+(importData.length-60)+' wiƒôcej</td></tr>';
  tbl+='</tbody></table>';
  document.getElementById('import-table-wrap').innerHTML=tbl;
  preview.style.display='block'; action.style.display='block';
  document.getElementById('push-log').innerHTML='';
}

async function pushToDB(){
  const skipDups=document.getElementById('skip-duplicates').checked;
  const btn=document.getElementById('push-btn'); btn.disabled=true; btn.textContent='‚è≥ Importujƒô...';
  let inserted=0,errors=0;
  logPush('üöÄ Importujƒô '+importData.length+' zada≈Ñ...','info');
  for(let i=0;i<importData.length;i++){
    const e=importData[i];
    const conflict=skipDups?'ON CONFLICT(id) DO NOTHING':
      'ON CONFLICT(id) DO UPDATE SET category_id=EXCLUDED.category_id,level=EXCLUDED.level,type=EXCLUDED.type,year=EXCLUDED.year,instruction=EXCLUDED.instruction,text=EXCLUDED.text,question=EXCLUDED.question,answer=EXCLUDED.answer,explanation=EXCLUDED.explanation,options=EXCLUDED.options,blanks=EXCLUDED.blanks';
    try{
      await sql('INSERT INTO exercises(id,category_id,level,type,year,instruction,text,question,answer,explanation,options,blanks) VALUES($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12) '+conflict,
        [e.id,e.category||null,e.level||'rozszerzony',e.type||null,e.year||null,e.instruction||null,e.text||null,e.question||null,e.answer||null,e.explanation||null,
         e.options?JSON.stringify(e.options):null,e.blanks?JSON.stringify(e.blanks):null]);
      if(i%10===0||i===importData.length-1) logPush('['+( i+1)+'/'+importData.length+'] '+e.id+' OK','ok');
      inserted++;
    }catch(err){ logPush('[' +(i+1)+'] '+e.id+': '+err.message,'error'); errors++; }
  }
  try{ exercises=await sql('SELECT * FROM exercises WHERE level=$1 ORDER BY id',[currentLevel]); }catch(e){}
  logPush('‚úÖ Zako≈Ñczono! Dodano: '+inserted+'  B≈Çƒôd√≥w: '+errors, errors===0?'done':'warn');
  setDBStatus('connected','Po≈ÇƒÖczono ¬∑ '+exercises.length+' zada≈Ñ');
  btn.disabled=false; btn.textContent='üöÄ Push do bazy';
}

function logPush(msg,type){
  const el=document.getElementById('push-log'); if(!el) return;
  const colors={info:'var(--text-muted)',ok:'var(--success)',error:'var(--error)',done:'var(--accent)',warn:'var(--warn)'};
  const d=document.createElement('div'); d.style.color=colors[type]||'var(--text)'; d.textContent=msg;
  el.appendChild(d); el.scrollTop=el.scrollHeight;
}

// =====================================================
// DB CONFIG
// =====================================================
function saveConfig(){
  localStorage.setItem('neon_user',document.getElementById('cfg-user').value.trim());
  showMsg('cfg-msg','‚úÖ Zapisano.','success'); init();
}

async function testConnection(){
  const det=document.getElementById('conn-details'); det.textContent='Testowanie...';
  try{
    const data=await sql('SELECT COUNT(*) as cnt FROM exercises');
    det.innerHTML='<span style="color:var(--success)">‚úÖ Po≈ÇƒÖczono!</span>\nUser: '+CONFIG.user+'\nZada≈Ñ: '+data[0]?.cnt;
    setDBStatus('connected','Po≈ÇƒÖczono');
  }catch(e){ det.innerHTML='<span style="color:var(--error)">‚ùå '+e.message+'</span>'; setDBStatus('error','B≈ÇƒÖd'); }
}

async function resetProgress(){
  if(!confirm('UsunƒÖƒá WSZYSTKIE postƒôpy?')) return;
  try{
    await sql('DELETE FROM user_progress WHERE user_id=$1',[CONFIG.user]);
    await sql('DELETE FROM session_history WHERE user_id=$1',[CONFIG.user]);
    try{ await sql('DELETE FROM answer_history WHERE user_id=$1',[CONFIG.user]); }catch(e){}
    progress={}; answerHistory=[];
    showMsg('cfg-msg','‚úÖ Reset wykonany.','success'); renderHome();
  }catch(e){ showMsg('cfg-msg','‚ùå '+e.message,'error'); }
}

async function loadSessionHistory(){
  const el=document.getElementById('session-history-list');
  try{
    const data=await sql('SELECT * FROM session_history WHERE user_id=$1 ORDER BY played_at DESC LIMIT 10',[CONFIG.user]);
    if(!data.length){ el.textContent='Brak historii.'; return; }
    el.innerHTML=data.map(h=>{
      const pct=h.total>0?Math.round(h.score/h.total*100):0;
      const lvl=h.level==='rozszerzony'?'PR':'PP';
      return `<div style="padding:.4rem 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;font-size:.82rem">
        <span>${new Date(h.played_at).toLocaleDateString('pl-PL')}</span>
        <span style="color:var(--text-muted)">${CATEGORIES[h.category_id]?.name||h.category_id} ¬∑ ${lvl}</span>
        <span style="color:${pct>=70?'var(--success)':pct>=50?'var(--warn)':'var(--error)'};font-family:'DM Mono',monospace">${pct}%</span>
      </div>`;
    }).join('');
  }catch(e){ el.textContent='≈Åadowanie...'; }
}

function showMsg(id,text,type){
  const el=document.getElementById(id); if(!el) return;
  el.style.color=type==='success'?'var(--success)':'var(--error)'; el.textContent=text;
  setTimeout(()=>el.textContent='',4000);
}

// =====================================================
// VIEWS
// =====================================================
function showView(name){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('view-'+name)?.classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b=>{
    if(b.getAttribute('onclick')==="showView('"+name+"')") b.classList.add('active');
  });
  if(name==='home')      renderHome();
  if(name==='stats')     renderStats();
  if(name==='history')   renderHistory();
  if(name==='theory')  { renderTheoryGrid(); document.getElementById('theory-grid-wrap').style.display='block'; document.getElementById('theory-article-wrap').style.display='none'; }
  if(name==='db-config'){ document.getElementById('cfg-user').value=CONFIG.user; loadSessionHistory(); }
  window.scrollTo({top:0,behavior:'smooth'});
}

// =====================================================
// CREATE answer_history TABLE IF NOT EXISTS
// =====================================================
async function ensureTables(){
  try{
    await sql(`CREATE TABLE IF NOT EXISTS answer_history (
      id SERIAL PRIMARY KEY,
      user_id TEXT NOT NULL,
      exercise_id TEXT NOT NULL,
      is_correct BOOLEAN NOT NULL,
      user_answer TEXT,
      answered_at TIMESTAMPTZ DEFAULT NOW()
    )`);
  }catch(e){ console.warn('ensure tables:',e.message); }
}

// =====================================================
// BOOT
// =====================================================
ensureTables().then(()=>init());

Object.assign(window,{
  init, showView, setLevel,
  saveConfig, testConnection, resetProgress, loadSessionHistory,
  startSession, endSession, nextExercise,
  checkAnswer, checkOption, selfGrade,
  renderStats, renderHistory, filterHistory,
  openTheory, closeTheory,
  loadJSONFile, parseJSONPaste, toggleJSONPaste, clearImport, pushToDB
});
</script>
</body>
</html>